<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Slony-I FAQ</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.74.0">
<link rel="home" href="index.html" title="Slony-I 1.2.14 Documentation">
<link rel="up" href="index.html" title="Slony-I 1.2.14 Documentation">
<link rel="prev" href="help.html" title="25. More Slony-I Help">
<link rel="next" href="commandreference.html" title="Part I. Core Slony-I Programs">
<link rel="copyright" href="legalnotice.html" title="Legal Notice">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" lang="en" id="faq">
<div class="titlepage">
<div>
<div><h2 class="title">Slony-I FAQ</h2></div>
<div><h3 class="corpauthor">The Slony Global Development Group</h3></div>
<div><div class="author"><h3 class="author">
<span class="firstname">Christopher </span> <span class="surname">Browne</span>
</h3></div></div>
</div>
<hr>
</div>
<p> Not all of these are, strictly speaking, &#8220;<span class="quote">frequently
asked;</span>&#8221; some represent <span class="emphasis"><em>trouble found that seemed
worth documenting</em></span>.</p>
<div class="qandaset">
<dl>
<dt>1.  <a href="faq.html#faqcompiling"> <span class="productname">Slony-I</span> FAQ: Building and Installing <span class="productname">Slony-I</span> </a>
</dt>
<dd><dl>
<dt>1.1. <a href="faq.html#id2602636"> I am using  Frotznik Freenix
4.5, with its FFPM (Frotznik Freenix
Package Manager) package management system.  It comes with
FFPM packages for PostgreSQL 7.4.7, which are what
I am using for my databases, but they don't include Slony-I in the
packaging.  How do I add Slony-I to this?  </a>
</dt>
<dt>1.2. <a href="faq.html#missingheaders"> I tried building Slony-I 1.1 and got the following
error message:
configure: error: Headers for libpqserver are not found in the includeserverdir.
   This is the path to postgres.h. Please specify the includeserverdir with
   --with-pgincludeserverdir=&lt;dir&gt;</a>
</dt>
<dt>1.3. <a href="faq.html#threadsafety"> Slony-I seemed to compile fine; now, when I run a
slon, some events are moving around, but no
replication is taking place.</a>
</dt>
<dt>1.4. <a href="faq.html#pg81funs"> I'm trying to upgrade to a newer version of Slony-I
and am running into a problem with UPDATE FUNCTIONS.  When I run UPDATE FUNCTIONS, my
postmaster falls over with a Signal 11.
There aren't any seeming errors in the log files, aside from the
PostgreSQL logs indicating that, yes indeed, the postmaster fell
over.</a>
</dt>
</dl></dd>
<dt>2.  <a href="faq.html#faqconnections"> <span class="productname">Slony-I</span> FAQ: Connection Issues </a>
</dt>
<dd><dl>
<dt>2.1. <a href="faq.html#id2603479">I looked for the _clustername namespace, and
it wasn't there.</a>
</dt>
<dt>2.2. <a href="faq.html#morethansuper"> I created a &#8220;superuser&#8221; account,
slony, to run replication activities.  As
suggested, I set it up as a superuser, via the following query: 
update pg_shadow set usesuper = 't' where usename in ('slony',
'molly', 'dumpy');
(that command also deals with other users I set up to run vacuums and
backups).</a>
</dt>
<dt>2.3. <a href="faq.html#id2603612"> I'm trying to get a slave subscribed, and get the
following messages in the logs:

DEBUG1 copy_set 1
DEBUG1 remoteWorkerThread_1: connected to provider DB
WARN	remoteWorkerThread_1: transactions earlier than XID 127314958 are still in progress
WARN	remoteWorkerThread_1: data copy for set 1 failed - sleep 60 seconds</a>
</dt>
<dt>2.4. <a href="faq.html#id2603698">Same as the above.  What I forgot to mention, as well,
was that I was trying to add TWO subscribers,
concurrently.</a>
</dt>
<dt>2.5. <a href="faq.html#missingoids"> We got bitten by
something we didn't foresee when completely uninstalling a slony
replication cluster from the master and slave...</a>
</dt>
<dt>2.6. <a href="faq.html#id2603861"> I upgraded my cluster to Slony-I version
1.2.  I'm now getting the following notice in the logs:</a>
</dt>
<dt>2.7. <a href="faq.html#id2603919">I pointed a subscribing node to a different provider
and it stopped replicating</a>
</dt>
<dt>2.8. <a href="faq.html#multipleslonconnections"> I was starting a slon, and got the
following &#8220;FATAL&#8221; messages in its logs.  What's up??? </a>
</dt>
<dt>2.9. <a href="faq.html#id2604220"> When can I shut down slon processes?</a>
</dt>
<dt>2.10. <a href="faq.html#id2604405"> Are there risks to doing so?  How about
benefits?</a>
</dt>
</dl></dd>
<dt>3.  <a href="faq.html#faqconfiguration"> <span class="productname">Slony-I</span> FAQ: Configuration Issues </a>
</dt>
<dd><dl>
<dt>3.1. <a href="faq.html#id2604450">Slonik fails - cannot load PostgreSQL library -
PGRES_FATAL_ERROR load '$libdir/xxid';</a>
</dt>
<dt>3.2. <a href="faq.html#id2604618">I tried creating a CLUSTER NAME with a "-" in it.
That didn't work.</a>
</dt>
<dt>3.3. <a href="faq.html#id2604649">ps finds passwords on command line</a>
</dt>
<dt>3.4. <a href="faq.html#id2604673">Table indexes with FQ namespace names

set add table (set id = 1, origin = 1, id = 27, 
               full qualified name = 'nspace.some_table', 
               key = 'key_on_whatever', 
               comment = 'Table some_table in namespace nspace with a candidate primary key');</a>
</dt>
<dt>3.5. <a href="faq.html#id2604700"> Replication has fallen behind, and it appears that the
queries to draw data from sl_log_1/sl_log_2 are taking a long time to pull just a few
SYNCs. </a>
</dt>
<dt>3.6. <a href="faq.html#id2604755"> I need to rename a column that is in the
primary key for one of my replicated tables.  That seems pretty
dangerous, doesn't it?  I have to drop the table out of replication
and recreate it, right?</a>
</dt>
<dt>3.7. <a href="faq.html#v72upgrade"> I have a PostgreSQL 7.2-based system that I
really, really want to use Slony-I to help me
upgrade it to 8.0.  What is involved in getting Slony-I to work for
that?</a>
</dt>
<dt>3.8. <a href="faq.html#id2604991"> I had a network &#8220;glitch&#8221; that led to my
using FAILOVER to fail over to an alternate node.
The failure wasn't a disk problem that would corrupt databases; why do
I need to rebuild the failed node from scratch? </a>
</dt>
<dt>3.9. <a href="faq.html#id2605068"> After notification of a subscription on
another node, replication falls over on one of
the subscribers, with the following error message:</a>
</dt>
<dt>3.10. <a href="faq.html#id2605167">I just used MOVE SET to move the
origin to a new node.  Unfortunately, some subscribers are still
pointing to the former origin node, so I can't take it out of service
for maintenance without stopping them from getting updates.  What do I
do?  </a>
</dt>
<dt>3.11. <a href="faq.html#id2605210"> After notification of a subscription on
another node, replication falls over, starting
with the following error message:</a>
</dt>
<dt>3.12. <a href="faq.html#id2605309"> Is the ordering of tables in a set significant?</a>
</dt>
<dt>3.13. <a href="faq.html#id2605379"> If you have a slonik script
something like this, it will hang on you and never complete, because
you can't have wait for event inside a
try block. A try block is
executed as one transaction, and the event that you are waiting for
can never arrive inside the scope of the transaction.</a>
</dt>
<dt>3.14. <a href="faq.html#id2605437">Slony-I: cannot add table to currently subscribed set 1</a>
</dt>
<dt>3.15. <a href="faq.html#id2605464">ERROR: duplicate key violates unique constraint "sl_table-pkey"</a>
</dt>
<dt>3.16. <a href="faq.html#id2605500"> One of my nodes fell over (slon / postmaster was
down) and nobody noticed for several days.  Now, when the slon for
that node starts up, it runs for about five minutes, then terminates,
with the error message: ERROR: remoteListenThread_%d: timeout
for event selection What's wrong, and what do I do? </a>
</dt>
</dl></dd>
<dt>4.  <a href="faq.html#faqperformance"> <span class="productname">Slony-I</span> FAQ: Performance Issues </a>
</dt>
<dd><dl>
<dt>4.1. <a href="faq.html#longtxnsareevil"> Replication has been slowing down, I'm seeing
 FETCH 100 FROM LOG  queries running for a long
time, sl_log_1 is growing, and performance is,
well, generally getting steadily worse. </a>
</dt>
<dt>4.2. <a href="faq.html#faq17">After dropping a node, sl_log_1
isn't getting purged out anymore.</a>
</dt>
<dt>4.3. <a href="faq.html#id2605979">The slon spent the weekend out of
commission [for some reason], and it's taking a long time to get a
sync through.</a>
</dt>
<dt>4.4. <a href="faq.html#pglistenerfull">Some nodes start consistently falling behind</a>
</dt>
<dt>4.5. <a href="faq.html#id2606187"> I have submitted a MOVE SET / EXECUTE SCRIPT request, and
it seems to be stuck on one of my nodes.  Slony-I logs aren't
displaying any errors or warnings </a>
</dt>
</dl></dd>
<dt>5.  <a href="faq.html#faqbugs"> <span class="productname">Slony-I</span> FAQ: <span class="productname">Slony-I</span> Bugs in Elder Versions </a>
</dt>
<dd><dl>
<dt>5.1. <a href="faq.html#id2606277">The slon processes servicing my
subscribers are growing to enormous size, challenging system resources
both in terms of swap space as well as moving towards breaking past
the 2GB maximum process size on my system. </a>
</dt>
<dt>5.2. <a href="faq.html#faqunicode"> I am trying to replicate
UNICODE data from PostgreSQL 8.0 to PostgreSQL 8.1, and
am experiencing problems. </a>
</dt>
<dt>5.3. <a href="faq.html#id2606572"> I am running Slony-I 1.1 and have a 4+ node setup
where there are two subscription sets, 1 and 2, that do not share any
nodes.  I am discovering that confirmations for set 1 never get to the
nodes subscribing to set 2, and that confirmations for set 2 never get
to nodes subscribing to set 1.  As a result, sl_log_1 grows and grows and is never purged.  This
was reported as Slony-I bug 1485 .</a>
</dt>
<dt>5.4. <a href="faq.html#id2606660"> I am finding some multibyte columns (Unicode, Big5)
are being truncated a bit, clipping off the last character.  Why?</a>
</dt>
<dt>5.5. <a href="faq.html#sequenceset"> Bug #1226  indicates an error condition that can come up if
you have a replication set that consists solely of sequences. </a>
</dt>
<dt>5.6. <a href="faq.html#id2606758">I need to drop a table from a replication set</a>
</dt>
<dt>5.7. <a href="faq.html#id2606853">I need to drop a sequence from a replication set</a>
</dt>
</dl></dd>
<dt>6.  <a href="faq.html#faqobsolete"> <span class="productname">Slony-I</span> FAQ: Hopefully Obsolete Issues </a>
</dt>
<dd><dl>
<dt>6.1. <a href="faq.html#id2606969"> slon does not restart after
crash</a>
</dt>
<dt>6.2. <a href="faq.html#id2607113"> I tried the following query which did not work:</a>
</dt>
<dt>6.3. <a href="faq.html#id2607245"> I can do a pg_dump
and load the data back in much faster than the SUBSCRIBE
SET runs.  Why is that?  </a>
</dt>
<dt>6.4. <a href="faq.html#dupkey">Replication Fails - Unique Constraint Violation</a>
</dt>
<dt>6.5. <a href="faq.html#id2607655">I started doing a backup using
pg_dump, and suddenly Slony
stops</a>
</dt>
</dl></dd>
<dt>7.  <a href="faq.html#faqoddities"> <span class="productname">Slony-I</span> FAQ: Oddities and Heavy Slony-I Hacking </a>
</dt>
<dd><dl>
<dt>7.1. <a href="faq.html#id2607855"> What happens with rules and triggers on
Slony-I-replicated tables?</a>
</dt>
<dt>7.2. <a href="faq.html#id2608031"> I was trying to request EXECUTE SCRIPT or MOVE SET, and found
messages as follows on one of the subscribers:</a>
</dt>
<dt>7.3. <a href="faq.html#neededexecddl"> Behaviour - all the subscriber nodes start to fall
behind the origin, and all the logs on the subscriber nodes have the
following error message repeating in them (when I encountered it,
there was a nice long SQL statement above each entry):</a>
</dt>
<dt>7.4. <a href="faq.html#id2608285"> Node #1 was dropped via DROP NODE, and the slon one of the
other nodes is repeatedly failing with the error message:</a>
</dt>
</dl></dd>
</dl>
<a name="id2602606"></a><table border="0" summary="Q and A Set">
<col align="left" width="1%">
<tbody>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqcompiling"></a>1.  <span class="productname">Slony-I</span> FAQ: Building and Installing <span class="productname">Slony-I</span> </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>1.1. <a href="faq.html#id2602636"> I am using  Frotznik Freenix
4.5, with its FFPM (Frotznik Freenix
Package Manager) package management system.  It comes with
FFPM packages for PostgreSQL 7.4.7, which are what
I am using for my databases, but they don't include Slony-I in the
packaging.  How do I add Slony-I to this?  </a>
</dt>
<dt>1.2. <a href="faq.html#missingheaders"> I tried building Slony-I 1.1 and got the following
error message:
configure: error: Headers for libpqserver are not found in the includeserverdir.
   This is the path to postgres.h. Please specify the includeserverdir with
   --with-pgincludeserverdir=&lt;dir&gt;</a>
</dt>
<dt>1.3. <a href="faq.html#threadsafety"> Slony-I seemed to compile fine; now, when I run a
slon, some events are moving around, but no
replication is taking place.</a>
</dt>
<dt>1.4. <a href="faq.html#pg81funs"> I'm trying to upgrade to a newer version of Slony-I
and am running into a problem with UPDATE FUNCTIONS.  When I run UPDATE FUNCTIONS, my
postmaster falls over with a Signal 11.
There aren't any seeming errors in the log files, aside from the
PostgreSQL logs indicating that, yes indeed, the postmaster fell
over.</a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2602636"></a><a name="id2602637"></a><p><b>1.1.</b></p>
</td>
<td align="left" valign="top"><p> I am using <span class="productname"> Frotznik Freenix
4.5</span>, with its <acronym class="acronym">FFPM</acronym> (Frotznik Freenix
Package Manager) package management system.  It comes with
<acronym class="acronym">FFPM</acronym> packages for <span class="productname">PostgreSQL</span> 7.4.7, which are what
I am using for my databases, but they don't include <span class="productname">Slony-I</span> in the
packaging.  How do I add <span class="productname">Slony-I</span> to this?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> <span class="productname">Frotznik Freenix</span> is new to
me, so it's a bit dangerous to give really hard-and-fast definitive
answers.  </p>
<p> The answers differ somewhat between the various combinations of
<span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> versions; the newer versions generally
somewhat easier to cope with than are the older versions.  In general,
you almost certainly need to compile <span class="productname">Slony-I</span> from sources; depending
on versioning of both <span class="productname">Slony-I</span> and <span class="productname">PostgreSQL</span>, you
<span class="emphasis"><em>may</em></span> need to compile <span class="productname">PostgreSQL</span> from scratch.
(Whether you need to <span class="emphasis"><em> use </em></span> the <span class="productname">PostgreSQL</span> compile
is another matter; you probably don't...) </p>
<div class="itemizedlist"><ul type="disc">
<li>
<p> <span class="productname">Slony-I</span> version 1.0.5 and earlier require having a
fully configured copy of <span class="productname">PostgreSQL</span> sources available when you compile
<span class="productname">Slony-I</span>.</p>
<p> <span class="emphasis"><em>Hopefully</em></span> you can make the configuration
this closely match against the configuration in use by the packaged
version of <span class="productname">PostgreSQL</span> by checking the configuration using the command
<code class="command"> pg_config --configure</code>. </p>
</li>
<li><p> <span class="productname">Slony-I</span> version 1.1 simplifies this considerably;
it does not require the full copy of <span class="productname">PostgreSQL</span> sources, but can,
instead, refer to the various locations where <span class="productname">PostgreSQL</span> libraries,
binaries, configuration, and <code class="command"> #include </code> files are
located.  </p></li>
<li>
<p> <span class="productname">PostgreSQL</span> 8.0 and higher is generally easier to deal
with in that a &#8220;<span class="quote">default</span>&#8221; installation includes all of the
<code class="command"> #include </code> files.  </p>
<p> If you are using an earlier version of <span class="productname">PostgreSQL</span>, you may find
it necessary to resort to a source installation if the packaged
version did not install the &#8220;<span class="quote">server
<code class="command">#include</code></span>&#8221; files, which are installed by the
command <code class="command"> make install-all-headers </code>.</p>
</li>
</ul></div>
<p> In effect, the &#8220;<span class="quote">worst case</span>&#8221; scenario takes place
if you are using a version of <span class="productname">Slony-I</span> earlier than 1.1 with an
&#8220;<span class="quote">elderly</span>&#8221; version of <span class="productname">PostgreSQL</span>, in which case you can
expect to need to compile <span class="productname">PostgreSQL</span> from scratch in order to have
everything that the <span class="productname">Slony-I</span> compile needs even though you are using a
&#8220;<span class="quote">packaged</span>&#8221; version of <span class="productname">PostgreSQL</span>.</p>
<p> If you are running a recent <span class="productname">PostgreSQL</span> and a recent <span class="productname">Slony-I</span>,
then the codependencies can be fairly small, and you may not need
extra <span class="productname">PostgreSQL</span> sources.  These improvements should ease the
production of <span class="productname">Slony-I</span> packages so that you might soon even be able to
hope to avoid compiling <span class="productname">Slony-I</span>.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="missingheaders"></a><a name="id2602953"></a><p><b>1.2.</b></p>
</td>
<td align="left" valign="top">
<p> I tried building <span class="productname">Slony-I</span> 1.1 and got the following
error message:
</p>
<pre class="screen">configure: error: Headers for libpqserver are not found in the includeserverdir.
   This is the path to postgres.h. Please specify the includeserverdir with
   --with-pgincludeserverdir=&lt;dir&gt;</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> You are almost certainly running version <span class="productname">PostgreSQL</span> 7.4
or earlier, where server headers are not installed by default if you
just do a <code class="command">make install</code> of <span class="productname">PostgreSQL</span>.</p>
<p> You need to install server headers when you install <span class="productname">PostgreSQL</span>
via the command <code class="command">make install-all-headers</code>.
</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="threadsafety"></a><a name="id2603017"></a><p><b>1.3.</b></p>
</td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> seemed to compile fine; now, when I run a
<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>, some events are moving around, but no
replication is taking place.</p>
<p> Slony logs might look like the following:

</p>
<pre class="screen">DEBUG1 remoteListenThread_1: connected to 'host=host004 dbname=pgbenchrep user=postgres port=5432'
ERROR  remoteListenThread_1: "select ev_origin, ev_seqno, ev_timestamp,
		  ev_minxid, ev_maxxid, ev_xip,
		  ev_type,
                  ev_data1, ev_data2,
		  ev_data3, ev_data4,
 	          ev_data5, ev_data6,
		  ev_data7, ev_data8 from "_pgbenchtest".sl_event e 
where (e.ev_origin = '1' and e.ev_seqno &gt; '1') order by e.ev_origin, e.ev_seqno" - could not receive data from server: Operation now in progress</pre>
<p> Alternatively, it may appear like...

</p>
<pre class="screen">ERROR  remoteListenThread_2: "select ev_origin, ev_seqno, ev_timestamp,
ev_minxid, ev_maxxid, ev_xip,        ev_type,        ev_data1, ev_data2,
ev_data3, ev_data4,        ev_data5, ev_data6,        ev_data7, ev_data8
from "_sl_p2t2".sl_event e where (e.ev_origin = '2' and e.ev_seqno &gt;
'0') order by e.ev_origin, e.ev_seqno" - could not receive data from
server: Error 0</pre>
<p> </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p>On AIX and Solaris (and possibly elsewhere), both
<span class="productname">Slony-I</span> <span class="emphasis"><em>and <span class="productname">PostgreSQL</span></em></span> must be compiled with the
<code class="option">--enable-thread-safety</code> option.  The above results
when <span class="productname">PostgreSQL</span> isn't so compiled.</p>
<p>What breaks here is that the libc (threadsafe) and libpq
(non-threadsafe) use different memory locations for errno, thereby
leading to the request failing.</p>
<p>Problems like this crop up with disadmirable regularity on AIX
and Solaris; it may take something of an &#8220;<span class="quote">object code audit</span>&#8221; to
make sure that <span class="emphasis"><em>ALL</em></span> of the necessary components have been
compiled and linked with <code class="option">--enable-thread-safety</code>.</p>
<p>For instance, I ran into the problem one that
<code class="envar">LD_LIBRARY_PATH</code> had been set, on Solaris, to point to
libraries from an old <span class="productname">PostgreSQL</span> compile.  That meant that even though
the database <span class="emphasis"><em>had</em></span> been compiled with
<code class="option">--enable-thread-safety</code>, and
<span class="application">slon</span> had been compiled against that,
<span class="application">slon</span> was being dynamically linked to the
&#8220;<span class="quote">bad old thread-unsafe version,</span>&#8221; so slon didn't work.  It
wasn't clear that this was the case until I ran <code class="command">ldd</code>
against <span class="application">slon</span>.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> Note that with libpq version 7.4.2, on Solaris, a
further <a class="link" href="installation.html#threadpatch"> thread patch </a> was
required; similar is also required for <span class="productname">PostgreSQL</span> version 8.0.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="pg81funs"></a><a name="id2603198"></a><p><b>1.4.</b></p>
</td>
<td align="left" valign="top">
<p> I'm trying to upgrade to a newer version of <span class="productname">Slony-I</span>
and am running into a problem with <a class="xref" href="stmtupdatefunctions.html" title="UPDATE FUNCTIONS"><span class="refentrytitle">UPDATE FUNCTIONS</span></a>.  When I run <a class="xref" href="stmtupdatefunctions.html" title="UPDATE FUNCTIONS"><span class="refentrytitle">UPDATE FUNCTIONS</span></a>, my
<span class="application">postmaster</span> falls over with a Signal 11.
There aren't any seeming errors in the log files, aside from the
<span class="productname">PostgreSQL</span> logs indicating that, yes indeed, the postmaster fell
over.</p>
<p> I connected a debugger to the core file, and it indicates that
it was trying to commit a transaction at the time of the
failure. </p>
<p> By the way I'm on <span class="productname">PostgreSQL</span> 8.1.[0-3]. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Unfortunately, early releases of <span class="productname">PostgreSQL</span> 8.1 had a
problem where if you redefined a function (such as, say,
<code class="function">upgradeSchema(text)</code>), and then, in the same
transaction, ran that function, the
<span class="application">postmaster</span> would fall over, and the
transaction would fail to commit.  </p>
<p> The <a class="xref" href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> command <a class="xref" href="stmtupdatefunctions.html" title="UPDATE FUNCTIONS"><span class="refentrytitle">UPDATE FUNCTIONS</span></a>
functions like that; it, in one transaction, tries to:

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Load the new functions (from <code class="filename">slony1_funcs.sql</code>), notably including <code class="function">upgradeSchema(text)</code>.  </p></li>
<li><p> Run <code class="function">upgradeSchema(text)</code> to do any necessary upgrades to the database schema. </p></li>
<li><p> Notify <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes of a change of configuration.</p></li>
</ul></div>
<p> Unfortunately, on <span class="productname">PostgreSQL</span> 8.1.0, 8.1.1, 8.1.2, and 8.1.3,
this conflicts with a bug where using and modifying a plpgsql function
in the same transaction leads to a crash. </p>
<p> Several workarounds are available. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The preferred answer would be to upgrade <span class="productname">PostgreSQL</span> to
8.1.4 or some later version.  Changes between minor versions do not
require rebuilding databases; it should merely require copying a
suitable 8.1.x build into place, and restarting the
<span class="application">postmaster</span> with the new version.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> If that is unsuitable, it would be possible to perform
the upgrade via a series of transactions, performing the equivalent of
what <a class="xref" href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> does &#8220;<span class="quote">by hand</span>&#8221;: </p>
<div class="itemizedlist"><ul type="disc">
<li>
<p> Take <code class="filename">slony1_funcs.sql</code> and do three replacements within it: </p>
<div class="itemizedlist"><ul type="circle">
<li><p> Replace &#8220;<span class="quote">@CLUSTERNAME@</span>&#8221; with the name of the cluster </p></li>
<li><p> Replace &#8220;<span class="quote">@MODULEVERSION@</span>&#8221; with the <span class="productname">Slony-I</span> version string, such as &#8220;<span class="quote">1.2.10</span>&#8221; </p></li>
<li><p> Replace &#8220;<span class="quote">@NAMESPACE@</span>&#8221; with the &#8220;<span class="quote">double-quoted</span>&#8221; name of the cluster namespace, such as "_MyCluster" </p></li>
</ul></div>
</li>
<li><p> Load that &#8220;<span class="quote">remapped</span>&#8221; set of functions into the database.</p></li>
<li><p> Run the stored function via <code class="command">select <code class="function">upgradeSchema('1.2.7')</code>; </code>, assuming that the previous version of <span class="productname">Slony-I</span> in use was version 1.2.7. </p></li>
<li><p> Restarting all <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes would probably be a wise move with this sort of &#8220;<span class="quote">surgery.</span>&#8221; </p></li>
</ul></div>
</td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqconnections"></a>2.  <span class="productname">Slony-I</span> FAQ: Connection Issues </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>2.1. <a href="faq.html#id2603479">I looked for the _clustername namespace, and
it wasn't there.</a>
</dt>
<dt>2.2. <a href="faq.html#morethansuper"> I created a &#8220;superuser&#8221; account,
slony, to run replication activities.  As
suggested, I set it up as a superuser, via the following query: 
update pg_shadow set usesuper = 't' where usename in ('slony',
'molly', 'dumpy');
(that command also deals with other users I set up to run vacuums and
backups).</a>
</dt>
<dt>2.3. <a href="faq.html#id2603612"> I'm trying to get a slave subscribed, and get the
following messages in the logs:

DEBUG1 copy_set 1
DEBUG1 remoteWorkerThread_1: connected to provider DB
WARN	remoteWorkerThread_1: transactions earlier than XID 127314958 are still in progress
WARN	remoteWorkerThread_1: data copy for set 1 failed - sleep 60 seconds</a>
</dt>
<dt>2.4. <a href="faq.html#id2603698">Same as the above.  What I forgot to mention, as well,
was that I was trying to add TWO subscribers,
concurrently.</a>
</dt>
<dt>2.5. <a href="faq.html#missingoids"> We got bitten by
something we didn't foresee when completely uninstalling a slony
replication cluster from the master and slave...</a>
</dt>
<dt>2.6. <a href="faq.html#id2603861"> I upgraded my cluster to Slony-I version
1.2.  I'm now getting the following notice in the logs:</a>
</dt>
<dt>2.7. <a href="faq.html#id2603919">I pointed a subscribing node to a different provider
and it stopped replicating</a>
</dt>
<dt>2.8. <a href="faq.html#multipleslonconnections"> I was starting a slon, and got the
following &#8220;FATAL&#8221; messages in its logs.  What's up??? </a>
</dt>
<dt>2.9. <a href="faq.html#id2604220"> When can I shut down slon processes?</a>
</dt>
<dt>2.10. <a href="faq.html#id2604405"> Are there risks to doing so?  How about
benefits?</a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2603479"></a><a name="id2603480"></a><p><b>2.1.</b></p>
</td>
<td align="left" valign="top"><p>I looked for the <code class="envar">_clustername</code> namespace, and
it wasn't there.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> If the DSNs are wrong, then <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>
instances can't connect to the nodes.</p>
<p>This will generally lead to nodes remaining entirely untouched.</p>
<p>Recheck the connection configuration.  By the way, since <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> links to libpq, you could have password information
stored in <code class="filename"> $HOME/.pgpass</code>, partially filling in
right/wrong authentication information there.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="morethansuper"></a><a name="id2603522"></a><p><b>2.2.</b></p>
</td>
<td align="left" valign="top">
<p> I created a &#8220;<span class="quote">superuser</span>&#8221; account,
<code class="command">slony</code>, to run replication activities.  As
suggested, I set it up as a superuser, via the following query: 
<code class="command">update pg_shadow set usesuper = 't' where usename in ('slony',
'molly', 'dumpy');</code>
(that command also deals with other users I set up to run vacuums and
backups).</p>
<p> Unfortunately, I ran into a problem the next time I subscribed
to a new set.</p>
<pre class="programlisting">DEBUG1 copy_set 28661
DEBUG1 remoteWorkerThread_1: connected to provider DB
DEBUG2 remoteWorkerThread_78: forward confirm 1,594436 received by 78
DEBUG2 remoteWorkerThread_1: copy table public.billing_discount
ERROR  remoteWorkerThread_1: "select "_mycluster".setAddTable_int(28661, 51, 'public.billing_discount', 'billing_discount_pkey', 'Table public.billing_discount with candidate primary key billing_discount_pkey'); " PGRES_FATAL_ERROR ERROR:  permission denied for relation pg_class
CONTEXT:  PL/pgSQL function "altertableforreplication" line 23 at select into variables
PL/pgSQL function "setaddtable_int" line 76 at perform
WARN   remoteWorkerThread_1: data copy for set 28661 failed - sleep 60 seconds</pre>
<p> This continues to fail, over and over, until I restarted the
<span class="application">slon</span> to connect as
<code class="command">postgres</code> instead.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The problem is fairly self-evident; permission is being
denied on the system table, <code class="envar">pg_class</code>.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> The &#8220;<span class="quote">fix</span>&#8221; is thus:</p>
<pre class="programlisting">update pg_shadow set usesuper = 't', usecatupd='t' where usename = 'slony';</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> In version 8.1 and higher, you may also need the following:</p>
<pre class="programlisting">update pg_authid set rolcatupdate = 't', rolsuper='t' where rolname = 'slony';</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2603612"></a><a name="id2603613"></a><p><b>2.3.</b></p>
</td>
<td align="left" valign="top">
<p> I'm trying to get a slave subscribed, and get the
following messages in the logs:

</p>
<pre class="screen">DEBUG1 copy_set 1
DEBUG1 remoteWorkerThread_1: connected to provider DB
WARN	remoteWorkerThread_1: transactions earlier than XID 127314958 are still in progress
WARN	remoteWorkerThread_1: data copy for set 1 failed - sleep 60 seconds</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> There is evidently some reasonably old outstanding
transaction blocking <span class="productname">Slony-I</span> from processing the sync.  You might
want to take a look at pg_locks to see what's up:</p>
<pre class="screen">sampledb=# select * from pg_locks where transaction is not null order by transaction;
 relation | database | transaction |  pid    |     mode      | granted 
----------+----------+-------------+---------+---------------+---------
          |          |   127314921 | 2605100 | ExclusiveLock | t
          |          |   127326504 | 5660904 | ExclusiveLock | t
(2 rows)</pre>
<p>See?  127314921 is indeed older than 127314958, and it's still
running.</p>
<p> A long running G/L report, a runaway
<span class="application">RT3</span> query, a
<span class="application">pg_dump</span>, all will open up transactions that
may run for substantial periods of time.  Until they complete, or are
interrupted, you will continue to see the message &#8220;<span class="quote"> data copy
for set 1 failed - sleep 60 seconds </span>&#8221;.</p>
<p>By the way, if there is more than one database on the <span class="productname">PostgreSQL</span>
cluster, and activity is taking place on the OTHER database, that will
lead to there being &#8220;<span class="quote">transactions earlier than XID
whatever</span>&#8221; being found to be still in progress.  The fact that
it's a separate database on the cluster is irrelevant; <span class="productname">Slony-I</span> will
wait until those old transactions terminate.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2603698"></a><a name="id2603699"></a><p><b>2.4.</b></p>
</td>
<td align="left" valign="top"><p>Same as the above.  What I forgot to mention, as well,
was that I was trying to add <span class="emphasis"><em>TWO</em></span> subscribers,
concurrently.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> That doesn't work out: <span class="productname">Slony-I</span> can't work on the
<code class="command">COPY</code> commands concurrently.  See
<code class="filename">src/slon/remote_worker.c</code>, function
<code class="function">copy_set()</code></p>
<pre class="screen">$ ps -aef | egrep '[2]605100'
postgres 2605100  205018	0 18:53:43  pts/3  3:13 postgres: postgres sampledb localhost COPY </pre>
<p>This happens to be a <code class="command">COPY</code> transaction
involved in setting up the subscription for one of the nodes.  All is
well; the system is busy setting up the first subscriber; it won't
start on the second one until the first one has completed subscribing.
That represents one possible cause.</p>
<p>This has the (perhaps unfortunate) implication that you cannot
populate two slaves concurrently from a single provider.  You have to
subscribe one to the set, and only once it has completed setting up
the subscription (copying table contents and such) can the second
subscriber start setting up the subscription.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="missingoids"></a><a name="id2603766"></a><p><b>2.5.</b></p>
</td>
<td align="left" valign="top">
<p> We got bitten by
something we didn't foresee when completely uninstalling a slony
replication cluster from the master and slave...</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Warning</h3>
<p><span class="emphasis"><em>MAKE SURE YOU STOP YOUR APPLICATION RUNNING
AGAINST YOUR MASTER DATABASE WHEN REMOVING THE WHOLE SLONY
CLUSTER</em></span>, or at least re-cycle all your open connections
after the event!  </p>
</div>
<p> The connections &#8220;<span class="quote">remember</span>&#8221; or refer to OIDs which
are removed by the uninstall node script. And you will get lots of
errors as a result...</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> There are two notable areas of
<span class="productname">PostgreSQL</span> that cache query plans and OIDs:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Prepared statements</p></li>
<li><p> pl/pgSQL functions</p></li>
</ul></div>
<p> The problem isn't particularly a <span class="productname">Slony-I</span> one; it would occur
any time such significant changes are made to the database schema.  It
shouldn't be expected to lead to data loss, but you'll see a wide
range of OID-related errors.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The problem occurs when you are using some sort of
&#8220;<span class="quote">connection pool</span>&#8221; that keeps recycling old connections.
If you restart the application after this, the new connections will
create <span class="emphasis"><em>new</em></span> query plans, and the errors will go
away.  If your connection pool drops the connections, and creates new
ones, the new ones will have <span class="emphasis"><em>new</em></span> query plans, and
the errors will go away. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> In our code we drop the connection on any error we
cannot map to an expected condition. This would eventually recycle all
connections on such unexpected problems after just one error per
connection.  Of course if the error surfaces as a constraint violation
which is a recognized condition, this won't help either, and if the
problem is persistent, the connections will keep recycling which will
drop the effect of the pooling, in the latter case the pooling code
could also announce an admin to take a look...  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> As of <span class="productname">PostgreSQL</span> 8.3, this should no longer be an
issue, as this version has code which invalidates query plans when
tables are altered. </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2603861"></a><a name="id2603862"></a><p><b>2.6.</b></p>
</td>
<td align="left" valign="top">
<p> I upgraded my cluster to <span class="productname">Slony-I</span> version
1.2.  I'm now getting the following notice in the logs:</p>
<pre class="screen">NOTICE:  Slony-I: log switch to sl_log_2 still in progress - sl_log_1 not truncated</pre>
<p> Both <code class="envar">sl_log_1</code> and <code class="envar">sl_log_2</code> are
continuing to grow, and <code class="envar">sl_log_1</code> is never getting
truncated.  What's wrong?</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> This is symptomatic of the same issue as above with
dropping replication: if there are still old connections lingering
that are using old query plans that reference the old stored
functions, resulting in the inserts to <code class="envar">sl_log_1</code> </p>
<p> Closing those connections and opening new ones will resolve the
issue. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> In the longer term, there is an item on the <span class="productname">PostgreSQL</span>
TODO list to implement dependancy checking that would flush cached
query plans when dependent objects change.  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2603919"></a><a name="id2603920"></a><p><b>2.7.</b></p>
</td>
<td align="left" valign="top"><p>I pointed a subscribing node to a different provider
and it stopped replicating</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p>We noticed this happening when we wanted to re-initialize a node,
where we had configuration thus:

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Node 1 - provider</p></li>
<li><p> Node 2 - subscriber to node 1 - the node we're reinitializing</p></li>
<li><p> Node 3 - subscriber to node 3 - node that should keep replicating</p></li>
</ul></div>
<p>The subscription for node 3 was changed to have node 1 as
provider, and we did <a class="xref" href="stmtdropset.html" title="DROP SET"><span class="refentrytitle">DROP SET</span></a> /<a class="xref" href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> for node 2 to get it repopulating.</p>
<p>Unfortunately, replication suddenly stopped to node 3.</p>
<p>The problem was that there was not a suitable set of
&#8220;<span class="quote">listener paths</span>&#8221; in <a class="xref" href="table.sl-listen.html" title="1.5.  Table: sl_listen">sl_listen</a> to allow the events from
node 1 to propagate to node 3.  The events were going through node 2,
and blocking behind the <a class="xref" href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> event that
node 2 was working on.</p>
<p>The following slonik script dropped out the listen paths where
node 3 had to go through node 2, and added in direct listens between
nodes 1 and 3.

</p>
<pre class="programlisting">cluster name = oxrslive;
 node 1 admin conninfo='host=32.85.68.220 dbname=oxrslive user=postgres port=5432';
 node 2 admin conninfo='host=32.85.68.216 dbname=oxrslive user=postgres port=5432';
 node 3 admin conninfo='host=32.85.68.244 dbname=oxrslive user=postgres port=5432';
 node 4 admin conninfo='host=10.28.103.132 dbname=oxrslive user=postgres port=5432';
try {
  store listen (origin = 1, receiver = 3, provider = 1);
  store listen (origin = 3, receiver = 1, provider = 3);
  drop listen (origin = 1, receiver = 3, provider = 2);
  drop listen (origin = 3, receiver = 1, provider = 2);
}</pre>
<p>Immediately after this script was run, <code class="command">SYNC</code>
events started propagating again to node 3.

This points out two principles:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> If you have multiple nodes, and cascaded subscribers,
you need to be quite careful in populating the <a class="xref" href="stmtstorelisten.html" title="STORE LISTEN"><span class="refentrytitle">STORE LISTEN</span></a> entries, and in modifying them if the
structure of the replication &#8220;<span class="quote">tree</span>&#8221;
changes.</p></li>
<li><p> Version 1.1 provides better tools to help manage
this.</p></li>
</ul></div>
<p>The issues of &#8220;<span class="quote">listener paths</span>&#8221; are discussed
further at <a class="xref" href="listenpaths.html" title="9. Slony-I listen paths">Section 9, &#8220;Slony-I listen paths&#8221;</a> </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="multipleslonconnections"></a><a name="id2604051"></a><p><b>2.8.</b></p>
</td>
<td align="left" valign="top">
<p> I was starting a <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>, and got the
following &#8220;<span class="quote">FATAL</span>&#8221; messages in its logs.  What's up??? </p>
<pre class="screen">2006-03-29 16:01:34 UTC CONFIG main: slon version 1.2.0 starting up
2006-03-29 16:01:34 UTC DEBUG2 slon: watchdog process started
2006-03-29 16:01:34 UTC DEBUG2 slon: watchdog ready - pid = 28326
2006-03-29 16:01:34 UTC DEBUG2 slon: worker process created - pid = 28327
2006-03-29 16:01:34 UTC CONFIG main: local node id = 1
2006-03-29 16:01:34 UTC DEBUG2 main: main process started
2006-03-29 16:01:34 UTC CONFIG main: launching sched_start_mainloop
2006-03-29 16:01:34 UTC CONFIG main: loading current cluster configuration
2006-03-29 16:01:34 UTC CONFIG storeSet: set_id=1 set_origin=1 set_comment='test set'
2006-03-29 16:01:34 UTC DEBUG2 sched_wakeup_node(): no_id=1 (0 threads + worker signaled)
2006-03-29 16:01:34 UTC DEBUG2 main: last local event sequence = 7
2006-03-29 16:01:34 UTC CONFIG main: configuration complete - starting threads
2006-03-29 16:01:34 UTC DEBUG1 localListenThread: thread starts
2006-03-29 16:01:34 UTC FATAL  localListenThread: "select "_test1538".cleanupNodelock(); insert into "_test1538".sl_nodelock values (    1, 0, "pg_catalog".pg_backend_pid()); " - ERROR:  duplicate key violates unique constraint "sl_nodelock-pkey"

2006-03-29 16:01:34 UTC FATAL  Do you already have a slon running against this node?
2006-03-29 16:01:34 UTC FATAL  Or perhaps a residual idle backend connection from a dead slon?</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The table <code class="envar">sl_nodelock</code> is used as an
&#8220;<span class="quote">interlock</span>&#8221; to prevent two <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes from trying
to manage the same node at the same time.  The <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> tries inserting
a record into the table; it can only succeed if it is the only node
manager. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> This error message is typically a sign that you have
started up a second <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> process for a given node.  The <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> asks
the obvious question: &#8220;<span class="quote">Do you already have a slon running
against this node?</span>&#8221; </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Supposing you experience some sort of network outage,
the connection between <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> and database may fail, and the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>
may figure this out long before the <span class="productname">PostgreSQL</span> instance it was
connected to does.  The result is that there will be some number of
idle connections left on the database server, which won't be closed
out until TCP/IP timeouts complete, which seems to normally take about
two hours.  For that two hour period, the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> will try to connect,
over and over, and will get the above fatal message, over and
over. </p>
<p> An administrator may clean this out by logging onto the server
and issuing <code class="command">kill -2</code> to any of the offending
connections.  Unfortunately, since the problem took place within the
networking layer, neither <span class="productname">PostgreSQL</span> nor <span class="productname">Slony-I</span> have a direct way of
detecting this. </p>
<p> You can <span class="emphasis"><em>mostly</em></span> avoid this by making sure
that <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes always run somewhere nearby the server that
each one manages.  If the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> runs on the same server as the
database it manages, any &#8220;<span class="quote">networking failure</span>&#8221; that could
interrupt local connections would be likely to be serious enough to
threaten the entire server.  </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604220"></a><a name="id2604221"></a><p><b>2.9.</b></p>
</td>
<td align="left" valign="top"><p> When can I shut down <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Generally, it's no big deal to shut down a <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>
process.  Each one is &#8220;<span class="quote">merely</span>&#8221; a <span class="productname">PostgreSQL</span> client,
managing one node, which spawns threads to manage receiving events
from other nodes.  </p>
<p>The &#8220;<span class="quote">event listening</span>&#8221; threads are no big deal; they
are doing nothing fancier than periodically checking remote nodes to
see if they have work to be done on this node.  If you kill off the
<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> these threads will be closed, which should have little or no
impact on much of anything.  Events generated while the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> is
down will be picked up when it is restarted.</p>
<p> The &#8220;<span class="quote">node managing</span>&#8221; thread is a bit more
interesting; most of the time, you can expect, on a subscriber, for
this thread to be processing <code class="command">SYNC</code> events.  If you
shut off the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> during an event, the transaction
will fail, and be rolled back, so that when the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> restarts, it
will have to go back and reprocess the event.</p>
<p> The only situation where this will
cause <span class="emphasis"><em>particular</em></span> &#8220;<span class="quote">heartburn</span>&#8221; is if
the event being processed was one which takes a long time to process,
such as <code class="command">COPY_SET</code> for a large replication
set. </p>
<p> The other thing that <span class="emphasis"><em>might</em></span> cause trouble
is if the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> runs fairly distant from nodes that it connects to;
you could discover that database connections are left <code class="command">idle in
transaction</code>.  This would normally only occur if the network
connection is destroyed without either <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> or database being made
aware of it.  In that case, you may discover
that &#8220;<span class="quote">zombied</span>&#8221; connections are left around for as long as
two hours if you don't go in by hand and kill off the <span class="productname">PostgreSQL</span>
backends.</p>
<p> There is one other case that could cause trouble; when the
<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> managing the origin node is not running,
no <code class="command">SYNC</code> events run against that node.  If the
<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> stays down for an extended period of time, and something
like <a class="xref" href="maintenance.html#gensync" title="6.2. Parallel to Watchdog: generate_syncs.sh">Section 6.2, &#8220;Parallel to Watchdog: generate_syncs.sh&#8221;</a> isn't running, you could be left
with <span class="emphasis"><em>one big <code class="command">SYNC</code></em></span> to process
when it comes back up.  But that is only a concern if that <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> is
down for an extended period of time; shutting it down for a few
seconds shouldn't cause any great problem. </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604405"></a><a name="id2604406"></a><p><b>2.10.</b></p>
</td>
<td align="left" valign="top"><p> Are there risks to doing so?  How about
benefits?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> In short, if you don't have something like an 18
hour <code class="command">COPY_SET</code> under way, it's normally not at all a
big deal to take a <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> down for a little while, or perhaps even
cycle <span class="emphasis"><em>all</em></span> the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>s. </p></td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqconfiguration"></a>3.  <span class="productname">Slony-I</span> FAQ: Configuration Issues </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>3.1. <a href="faq.html#id2604450">Slonik fails - cannot load PostgreSQL library -
PGRES_FATAL_ERROR load '$libdir/xxid';</a>
</dt>
<dt>3.2. <a href="faq.html#id2604618">I tried creating a CLUSTER NAME with a "-" in it.
That didn't work.</a>
</dt>
<dt>3.3. <a href="faq.html#id2604649">ps finds passwords on command line</a>
</dt>
<dt>3.4. <a href="faq.html#id2604673">Table indexes with FQ namespace names

set add table (set id = 1, origin = 1, id = 27, 
               full qualified name = 'nspace.some_table', 
               key = 'key_on_whatever', 
               comment = 'Table some_table in namespace nspace with a candidate primary key');</a>
</dt>
<dt>3.5. <a href="faq.html#id2604700"> Replication has fallen behind, and it appears that the
queries to draw data from sl_log_1/sl_log_2 are taking a long time to pull just a few
SYNCs. </a>
</dt>
<dt>3.6. <a href="faq.html#id2604755"> I need to rename a column that is in the
primary key for one of my replicated tables.  That seems pretty
dangerous, doesn't it?  I have to drop the table out of replication
and recreate it, right?</a>
</dt>
<dt>3.7. <a href="faq.html#v72upgrade"> I have a PostgreSQL 7.2-based system that I
really, really want to use Slony-I to help me
upgrade it to 8.0.  What is involved in getting Slony-I to work for
that?</a>
</dt>
<dt>3.8. <a href="faq.html#id2604991"> I had a network &#8220;glitch&#8221; that led to my
using FAILOVER to fail over to an alternate node.
The failure wasn't a disk problem that would corrupt databases; why do
I need to rebuild the failed node from scratch? </a>
</dt>
<dt>3.9. <a href="faq.html#id2605068"> After notification of a subscription on
another node, replication falls over on one of
the subscribers, with the following error message:</a>
</dt>
<dt>3.10. <a href="faq.html#id2605167">I just used MOVE SET to move the
origin to a new node.  Unfortunately, some subscribers are still
pointing to the former origin node, so I can't take it out of service
for maintenance without stopping them from getting updates.  What do I
do?  </a>
</dt>
<dt>3.11. <a href="faq.html#id2605210"> After notification of a subscription on
another node, replication falls over, starting
with the following error message:</a>
</dt>
<dt>3.12. <a href="faq.html#id2605309"> Is the ordering of tables in a set significant?</a>
</dt>
<dt>3.13. <a href="faq.html#id2605379"> If you have a slonik script
something like this, it will hang on you and never complete, because
you can't have wait for event inside a
try block. A try block is
executed as one transaction, and the event that you are waiting for
can never arrive inside the scope of the transaction.</a>
</dt>
<dt>3.14. <a href="faq.html#id2605437">Slony-I: cannot add table to currently subscribed set 1</a>
</dt>
<dt>3.15. <a href="faq.html#id2605464">ERROR: duplicate key violates unique constraint "sl_table-pkey"</a>
</dt>
<dt>3.16. <a href="faq.html#id2605500"> One of my nodes fell over (slon / postmaster was
down) and nobody noticed for several days.  Now, when the slon for
that node starts up, it runs for about five minutes, then terminates,
with the error message: ERROR: remoteListenThread_%d: timeout
for event selection What's wrong, and what do I do? </a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604450"></a><a name="id2604452"></a><p><b>3.1.</b></p>
</td>
<td align="left" valign="top">
<p>Slonik fails - cannot load <span class="productname">PostgreSQL</span> library -
<code class="command">PGRES_FATAL_ERROR load '$libdir/xxid';</code></p>
<p> When I run the sample setup script I get an error message similar
to:

<code class="command">stdin:64: PGRES_FATAL_ERROR load '$libdir/xxid';  - ERROR:  LOAD:
could not open file '$libdir/xxid': No such file or directory</code></p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Evidently, you haven't got the
<code class="filename">xxid.so</code> library in the <code class="envar">$libdir</code>
directory that the <span class="productname">PostgreSQL</span> instance is
using.  Note that the <span class="productname">Slony-I</span> components
need to be installed in the <span class="productname">PostgreSQL</span>
software installation for <span class="emphasis"><em>each and every one</em></span> of
the nodes, not just on the origin node.</p>
<p>This may also point to there being some other mismatch between
the <span class="productname">PostgreSQL</span> binary instance and the <span class="productname">Slony-I</span> instance.  If you
compiled <span class="productname">Slony-I</span> yourself, on a machine that may have multiple
<span class="productname">PostgreSQL</span> builds &#8220;<span class="quote">lying around,</span>&#8221; it's possible that the
slon or slonik binaries are asking to load something that isn't
actually in the library directory for the <span class="productname">PostgreSQL</span> database cluster
that it's hitting.</p>
<p>Long and short: This points to a need to &#8220;<span class="quote">audit</span>&#8221;
what installations of <span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> you have in place on the
machine(s).  Unfortunately, just about any mismatch will cause things
not to link up quite right.  See also <a class="link" href="faq.html#threadsafety" title="Question">thread safety </a> concerning threading issues on Solaris
...</p>
<p> Life is simplest if you only have one set of <span class="productname">PostgreSQL</span>
binaries on a given server; in that case, there isn't a &#8220;<span class="quote">wrong
place</span>&#8221; in which <span class="productname">Slony-I</span> components might get installed.  If
you have several software installs, you'll have to verify that the
right versions of <span class="productname">Slony-I</span> components are associated with the right
<span class="productname">PostgreSQL</span> binaries. </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604618"></a><a name="id2604619"></a><p><b>3.2.</b></p>
</td>
<td align="left" valign="top"><p>I tried creating a CLUSTER NAME with a "-" in it.
That didn't work.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> uses the same rules for unquoted identifiers
as the <span class="productname">PostgreSQL</span> main parser, so no, you probably shouldn't put a "-"
in your identifier name.</p>
<p> You may be able to defeat this by putting &#8220;<span class="quote">quotes</span>&#8221; around
identifier names, but it's still liable to bite you some, so this is
something that is probably not worth working around.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604649"></a><a name="id2604650"></a><p><b>3.3.</b></p>
</td>
<td align="left" valign="top">
<p>ps finds passwords on command line</p>
<p> If I run a <code class="command">ps</code> command, I, and everyone else,
can see passwords on the command line.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p>Take the passwords out of the Slony configuration, and
put them into <code class="filename">$(HOME)/.pgpass.</code></p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604673"></a><a name="id2604674"></a><p><b>3.4.</b></p>
</td>
<td align="left" valign="top">
<p>Table indexes with FQ namespace names

</p>
<pre class="programlisting">set add table (set id = 1, origin = 1, id = 27, 
               full qualified name = 'nspace.some_table', 
               key = 'key_on_whatever', 
               comment = 'Table some_table in namespace nspace with a candidate primary key');</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> If you have <code class="command"> key =
'nspace.key_on_whatever'</code> the request will
<span class="emphasis"><em>FAIL</em></span>.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604700"></a><a name="id2604702"></a><p><b>3.5.</b></p>
</td>
<td align="left" valign="top"><p> Replication has fallen behind, and it appears that the
queries to draw data from <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>/<a class="xref" href="table.sl-log-2.html" title="1.7.  Table: sl_log_2">sl_log_2</a> are taking a long time to pull just a few
<code class="command">SYNC</code>s. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> Until version 1.1.1, there was only one index on <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>/<a class="xref" href="table.sl-log-2.html" title="1.7.  Table: sl_log_2">sl_log_2</a>, and if
there were multiple replication sets, some of the columns on the index
would not provide meaningful selectivity.  If there is no index on
column <code class="function"> log_xid</code>, consider adding it.  See
<code class="filename">slony1_base.sql</code> for an example of how to create
the index.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604755"></a><a name="id2604756"></a><p><b>3.6.</b></p>
</td>
<td align="left" valign="top"><p> I need to rename a column that is in the
primary key for one of my replicated tables.  That seems pretty
dangerous, doesn't it?  I have to drop the table out of replication
and recreate it, right?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Actually, this is a scenario which works out remarkably
cleanly.  <span class="productname">Slony-I</span> does indeed make intense use of the primary key
columns, but actually does so in a manner that allows this sort of
change to be made very nearly transparently.</p>
<p> Suppose you revise a column name, as with the SQL DDL <code class="command">alter table accounts alter column aid rename to cid; </code> This
revises the names of the columns in the table; it
<span class="emphasis"><em>simultaneously</em></span> renames the names of the columns
in the primary key index.  The result is that the normal course of
things is that altering a column name affects both aspects
simultaneously on a given node.</p>
<p> The <span class="emphasis"><em>ideal</em></span> and proper handling of this
change would involve using <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> to deploy
the alteration, which ensures it is applied at exactly the right point
in the transaction stream on each node.</p>
<p> Interestingly, that isn't forcibly necessary.  As long as the
alteration is applied on the replication set's origin before
application on subscribers, things won't break irrepairably.  Some
<code class="command">SYNC</code> events that do not include changes to the
altered table can make it through without any difficulty...  At the
point that the first update to the table is drawn in by a subscriber,
<span class="emphasis"><em>that</em></span> is the point at which
<code class="command">SYNC</code> events will start to fail, as the provider
will indicate the &#8220;<span class="quote">new</span>&#8221; set of columns whilst the
subscriber still has the &#8220;<span class="quote">old</span>&#8221; ones.  If you then apply
the alteration to the subscriber, it can retry the
<code class="command">SYNC</code>, at which point it will, finding the
&#8220;<span class="quote">new</span>&#8221; column names, work just fine.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="v72upgrade"></a><a name="id2604857"></a><p><b>3.7.</b></p>
</td>
<td align="left" valign="top"><p> I have a <span class="productname">PostgreSQL</span> 7.2-based system that I
<span class="emphasis"><em>really, really</em></span> want to use <span class="productname">Slony-I</span> to help me
upgrade it to 8.0.  What is involved in getting <span class="productname">Slony-I</span> to work for
that?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Rod Taylor has reported the following...</p>
<p> This is approximately what you need to do:</p>
<div class="itemizedlist"><ul type="disc">
<li><p>Take the 7.3 templates and copy them to 7.2 -- or otherwise
        hardcode the version your using to pick up the 7.3 templates </p></li>
<li><p>Remove all traces of schemas from the code and sql templates. I
        basically changed the "." to an "_". </p></li>
<li><p> Bunch of work related to the XID datatype and functions. For
        example, Slony creates CASTs for the xid to xxid and back -- but
        7.2 cannot create new casts that way so you need to edit system
        tables by hand. I recall creating an Operator Class and editing
        several functions as well. </p></li>
<li><p>sl_log_1 will have severe performance problems with any kind of
        data volume. This required a number of index and query changes
        to optimize for 7.2. 7.3 and above are quite a bit smarter in
        terms of optimizations they can apply. </p></li>
<li><p> Don't bother trying to make sequences work. Do them by hand
        after the upgrade using pg_dump and grep. </p></li>
</ul></div>
<p> Of course, now that you have done all of the above, it's not compatible
with standard Slony now. So you either need to implement 7.2 in a less
hackish way, or you can also hack up slony to work without schemas on
newer versions of <span class="productname">PostgreSQL</span> so they can talk to each other.</p>
<p> Almost immediately after getting the DB upgraded from 7.2 to 7.4, we
deinstalled the hacked up Slony (by hand for the most part), and started
a migration from 7.4 to 7.4 on a different machine using the regular
Slony. This was primarily to ensure we didn't keep our system catalogues
which had been manually fiddled with.</p>
<p> All that said, we upgraded a few hundred GB from 7.2 to 7.4
with about 30 minutes actual downtime (versus 48 hours for a dump /
restore cycle) and no data loss.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> That represents a sufficiently ugly set of
&#8220;<span class="quote">hackery</span>&#8221; that the developers are exceedingly reluctant
to let it anywhere near to the production code.  If someone were
interested in &#8220;<span class="quote">productionizing</span>&#8221; this, it would probably
make sense to do so based on the <span class="productname">Slony-I</span> 1.0 branch, with the express
plan of <span class="emphasis"><em>not</em></span> trying to keep much in the way of
forwards compatibility or long term maintainability of replicas.</p>
<p> You should only head down this road if you are sufficiently
comfortable with <span class="productname">PostgreSQL</span> and <span class="productname">Slony-I</span> that you are prepared to hack
pretty heavily with the code.  </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2604991"></a><a name="id2604992"></a><p><b>3.8.</b></p>
</td>
<td align="left" valign="top"><p> I had a network &#8220;<span class="quote">glitch</span>&#8221; that led to my
using <a class="xref" href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> to fail over to an alternate node.
The failure wasn't a disk problem that would corrupt databases; why do
I need to rebuild the failed node from scratch? </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The action of <a class="xref" href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> is to
<span class="emphasis"><em>abandon</em></span> the failed node so that no more <span class="productname">Slony-I</span>
activity goes to or from that node.  As soon as that takes place, the
failed node will progressively fall further and further out of sync.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The <span class="emphasis"><em>big</em></span> problem with trying to
recover the failed node is that it may contain updates that never made
it out of the origin.  If they get retried, on the new origin, you may
find that you have conflicting updates.  In any case, you do have a
sort of &#8220;<span class="quote">logical</span>&#8221; corruption of the data even if there
never was a disk failure making it &#8220;<span class="quote">physical.</span>&#8221;</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> As discusssed in <a class="xref" href="failover.html" title="8. Doing switchover and failover with Slony-I">Section 8, &#8220;Doing switchover and failover with Slony-I&#8221;</a>, using <a class="xref" href="stmtfailover.html" title="FAILOVER"><span class="refentrytitle">FAILOVER</span></a> should be considered a <span class="emphasis"><em>last
resort</em></span> as it implies that you are abandoning the origin
node as being corrupted.  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605068"></a><a name="id2605070"></a><p><b>3.9.</b></p>
</td>
<td align="left" valign="top">
<p> After notification of a subscription on
<span class="emphasis"><em>another</em></span> node, replication falls over on one of
the subscribers, with the following error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_1: "begin transaction; set transaction isolation level serializable; lock table "_livesystem".sl_config_lock; select "_livesystem".enableSubscription(25506, 1, 501); notify "_livesystem_Event"; notify "_livesystem_Confirm"; insert into "_livesystem".sl_event     (ev_origin, ev_seqno, ev_timestamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('1', '4896546', '2005-01-23 16:08:55.037395', '1745281261', '1745281262', '', 'ENABLE_SUBSCRIPTION', '25506', '1', '501', 't'); insert into "_livesystem".sl_confirm      (con_origin, con_received, con_seqno, con_timestamp)    values (1, 4, '4896546', CURRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
DETAIL:  Key (sub_provider,sub_receiver)=(1,501) is not present in table "sl_path".</pre>
<p> This is then followed by a series of failed syncs as the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shuts down:</p>
<pre class="screen">DEBUG2 remoteListenThread_1: queue event 1,4897517 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897518 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897519 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897520 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897521 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897522 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897523 SYNC</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> If you see a <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shutting down with
<span class="emphasis"><em>ignore new events due to shutdown</em></span> log entries,
you typically need to step back in the log to
<span class="emphasis"><em>before</em></span> they started failing to see indication of
the root cause of the problem.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> In this particular case, the problem was that some of
the <a class="xref" href="stmtstorepath.html" title="STORE PATH"><span class="refentrytitle">STORE
     PATH</span></a> commands had not yet made it to
node 4 before the <a class="xref" href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> command
propagated. </p>
<p>This demonstrates yet another example of the need to not do
things in a rush; you need to be sure things are working right
<span class="emphasis"><em>before</em></span> making further configuration changes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605167"></a><a name="id2605168"></a><p><b>3.10.</b></p>
</td>
<td align="left" valign="top"><p>I just used <a class="xref" href="stmtmoveset.html" title="MOVE SET"><span class="refentrytitle">MOVE SET</span></a> to move the
origin to a new node.  Unfortunately, some subscribers are still
pointing to the former origin node, so I can't take it out of service
for maintenance without stopping them from getting updates.  What do I
do?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> You need to use <a class="xref" href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> to
alter the subscriptions for those nodes to have them subscribe to a
provider that <span class="emphasis"><em>will</em></span> be sticking around during the
maintenance.</p>
<div class="warning" style="margin-left: 0.5in; margin-right: 0.5in;">
<h3 class="title">Warning</h3>
<p> What you <span class="emphasis"><em>don't</em></span> do is to <a class="xref" href="stmtunsubscribeset.html" title="UNSUBSCRIBE SET"><span class="refentrytitle">UNSUBSCRIBE SET</span></a>; that would require reloading all data
for the nodes from scratch later.
</p>
</div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605210"></a><a name="id2605211"></a><p><b>3.11.</b></p>
</td>
<td align="left" valign="top">
<p> After notification of a subscription on
<span class="emphasis"><em>another</em></span> node, replication falls over, starting
with the following error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_1: "begin transaction; set transaction isolation level serializable; lock table "_livesystem".sl_config_lock; select "_livesystem".enableSubscription(25506, 1, 501); notify "_livesystem_Event"; notify "_livesystem_Confirm"; insert into "_livesystem".sl_event     (ev_origin, ev_seqno, ev_timestamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3, ev_data4    ) values ('1', '4896546', '2005-01-23 16:08:55.037395', '1745281261', '1745281262', '', 'ENABLE_SUBSCRIPTION', '25506', '1', '501', 't'); insert into "_livesystem".sl_confirm      (con_origin, con_received, con_seqno, con_timestamp)    values (1, 4, '4896546', CURRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or update on table "sl_subscribe" violates foreign key constraint "sl_subscribe-sl_path-ref"
DETAIL:  Key (sub_provider,sub_receiver)=(1,501) is not present in table "sl_path".</pre>
<p> This is then followed by a series of failed syncs as the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shuts down:

</p>
<pre class="screen">DEBUG2 remoteListenThread_1: queue event 1,4897517 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897518 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897519 SYNC
DEBUG2 remoteListenThread_1: queue event 1,4897520 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897521 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897522 SYNC
DEBUG2 remoteWorker_event: ignore new events due to shutdown
DEBUG2 remoteListenThread_1: queue event 1,4897523 SYNC</pre>
<p>
</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> If you see a <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> shutting down with
<span class="emphasis"><em>ignore new events due to shutdown</em></span> log entries,
you'll typically have to step back to <span class="emphasis"><em>before</em></span> they
started failing to see indication of the root cause of the problem.
</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> In this particular case, the problem was that some of
the <a class="xref" href="stmtstorepath.html" title="STORE PATH"><span class="refentrytitle">STORE
     PATH</span></a> commands had not yet made it to
node 4 before the <a class="xref" href="stmtsubscribeset.html" title="SUBSCRIBE SET"><span class="refentrytitle">SUBSCRIBE SET</span></a> command
propagated. </p>
<p>This is yet another example of the need to not do things too
terribly quickly; you need to be sure things are working right
<span class="emphasis"><em>before</em></span> making further configuration changes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605309"></a><a name="id2605310"></a><p><b>3.12.</b></p>
</td>
<td align="left" valign="top"><p> Is the ordering of tables in a set significant?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> Most of the time, it isn't.  You might imagine it of
some value to order the tables in some particular way in order that
&#8220;<span class="quote">parent</span>&#8221; entries would make it in before their &#8220;<span class="quote">children</span>&#8221;
in some foreign key relationship; that <span class="emphasis"><em>isn't</em></span> the case since
foreign key constraint triggers are turned off on subscriber nodes.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p>(Jan Wieck comments:) The order of table ID's is only
significant during a <a class="xref" href="stmtlockset.html" title="LOCK SET"><span class="refentrytitle">LOCK SET</span></a> in preparation of
switchover. If that order is different from the order in which an
application is acquiring its locks, it can lead to deadlocks that
abort either the application or <span class="application">slon</span>.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> (David Parker) I ran into one other case where the
ordering of tables in the set was significant: in the presence of
inherited tables. If a child table appears before its parent in a set,
then the initial subscription will end up deleting that child table
after it has possibly already received data, because the
<code class="command">copy_set</code> logic does a <code class="command">delete</code>,
not a <code class="command">delete only</code>, so the delete of the parent will
delete the new rows in the child as well.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605379"></a><a name="id2605380"></a><p><b>3.13.</b></p>
</td>
<td align="left" valign="top">
<p> If you have a <a class="xref" href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> script
something like this, it will hang on you and never complete, because
you can't have <code class="command">wait for event</code> inside a
<code class="command">try</code> block. A <code class="command">try</code> block is
executed as one transaction, and the event that you are waiting for
can never arrive inside the scope of the transaction.</p>
<pre class="programlisting">try {
      echo 'Moving set 1 to node 3';
      lock set (id=1, origin=1);
      echo 'Set locked';
      wait for event (origin = 1, confirmed = 3);
      echo 'Moving set';
      move set (id=1, old origin=1, new origin=3);
      echo 'Set moved - waiting for event to be confirmed by node 3';
      wait for event (origin = 1, confirmed = 3);
      echo 'Confirmed';
} on error {
      echo 'Could not move set for cluster foo';
      unlock set (id=1, origin=1);
      exit -1;
}</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> You must not invoke <a class="xref" href="stmtwaitevent.html" title="WAIT FOR EVENT"><span class="refentrytitle">WAIT FOR EVENT</span></a>
inside a &#8220;<span class="quote">try</span>&#8221; block.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605437"></a><a name="id2605438"></a><p><b>3.14.</b></p>
</td>
<td align="left" valign="top">
<p>Slony-I: cannot add table to currently subscribed set 1</p>
<p> I tried to add a table to a set, and got the following message:

</p>
<pre class="screen">	Slony-I: cannot add table to currently subscribed set 1</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> You cannot add tables to sets that already have
subscribers.</p>
<p>The workaround to this is to create <span class="emphasis"><em>ANOTHER</em></span>
set, add the new tables to that new set, subscribe the same nodes
subscribing to "set 1" to the new set, and then merge the sets
together.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605464"></a><a name="id2605465"></a><p><b>3.15.</b></p>
</td>
<td align="left" valign="top">
<p>ERROR: duplicate key violates unique constraint "sl_table-pkey"</p>
<p>I tried setting up a second replication set, and got the following error:

</p>
<pre class="screen">stdin:9: Could not create subscription set 2 for oxrslive!
stdin:11: PGRES_FATAL_ERROR select "_oxrslive".setAddTable(2, 1, 'public.replic_test', 'replic_test__Slony-I_oxrslive_rowID_key', 'Table public.replic_test without primary key');  - ERROR:  duplicate key violates unique constraint "sl_table-pkey"
CONTEXT:  PL/pgSQL function "setaddtable_int" line 71 at SQL statement</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The table IDs used in <a class="xref" href="stmtsetaddtable.html" title="SET ADD TABLE"><span class="refentrytitle">SET ADD TABLE</span></a>
are required to be unique <span class="emphasis"><em>ACROSS ALL SETS</em></span>.  Thus,
you can't restart numbering at 1 for a second set; if you are
numbering them consecutively, a subsequent set has to start with IDs
after where the previous set(s) left off.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605500"></a><a name="id2605502"></a><p><b>3.16.</b></p>
</td>
<td align="left" valign="top"><p> One of my nodes fell over (<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> / postmaster was
down) and nobody noticed for several days.  Now, when the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> for
that node starts up, it runs for about five minutes, then terminates,
with the error message: <code class="command">ERROR: remoteListenThread_%d: timeout
for event selection</code> What's wrong, and what do I do? </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The problem is that the listener thread (in
<code class="filename">src/slon/remote_listener.c</code>) timed out when trying
to determine what events were outstanding for that node.  By default,
the query will run for five minutes; if there were many days worth of
outstanding events, this might take too long.
 </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> On  versions of <span class="productname">Slony-I</span> before 1.1.7, 1.2.7, and 1.3, one answer would be to increase the timeout in 
<code class="filename">src/slon/remote_listener.c</code>, recompile <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>, and retry.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> Another would be to treat the node as having failed,
and use the <a class="xref" href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a> command <a class="xref" href="stmtdropnode.html" title="DROP NODE"><span class="refentrytitle">DROP NODE</span></a> to drop the
node, and recreate it.  If the database is heavily updated, it may
well be cheaper to do this than it is to find a way to let it catch
up.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> In newer versions of <span class="productname">Slony-I</span>, there is a new
configuration parameter called <a class="xref" href="slon-config-interval.html#slon-config-remote-listen-timeout">slon_conf_remote_listen_timeout</a>; you'd alter the config
file to increase the timeout, and try again.  Of course, as mentioned
above, it could be faster to drop the node and recreate it than to let
it catch up across a week's worth of updates...  </p></td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqperformance"></a>4.  <span class="productname">Slony-I</span> FAQ: Performance Issues </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>4.1. <a href="faq.html#longtxnsareevil"> Replication has been slowing down, I'm seeing
 FETCH 100 FROM LOG  queries running for a long
time, sl_log_1 is growing, and performance is,
well, generally getting steadily worse. </a>
</dt>
<dt>4.2. <a href="faq.html#faq17">After dropping a node, sl_log_1
isn't getting purged out anymore.</a>
</dt>
<dt>4.3. <a href="faq.html#id2605979">The slon spent the weekend out of
commission [for some reason], and it's taking a long time to get a
sync through.</a>
</dt>
<dt>4.4. <a href="faq.html#pglistenerfull">Some nodes start consistently falling behind</a>
</dt>
<dt>4.5. <a href="faq.html#id2606187"> I have submitted a MOVE SET / EXECUTE SCRIPT request, and
it seems to be stuck on one of my nodes.  Slony-I logs aren't
displaying any errors or warnings </a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="longtxnsareevil"></a><a name="id2605620"></a><p><b>4.1.</b></p>
</td>
<td align="left" valign="top"><p> Replication has been slowing down, I'm seeing
<code class="command"> FETCH 100 FROM LOG </code> queries running for a long
time, <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> is growing, and performance is,
well, generally getting steadily worse. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> There are actually a number of possible causes for
this sort of thing.  There is a question involving similar pathology
where the problem is that <a class="link" href="faq.html#pglistenerfull" title="Question"> 
<code class="envar">pg_listener</code> grows because it is not vacuumed. </a></p>
<p> Another &#8220;<span class="quote"> proximate cause </span>&#8221; for this growth is for
there to be a connection connected to the node that sits <code class="command">IDLE IN TRANSACTION </code> for a very long time. </p>
<p> That open transaction will have multiple negative effects, all
of which will adversely affect performance:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Vacuums on all tables, including <code class="envar">pg_listener</code>, will
not clear out dead tuples from before the start of the idle
transaction. </p></li>
<li><p> The cleanup thread will be unable to clean out
entries in <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> and <a class="xref" href="table.sl-seqlog.html" title="1.13.  Table: sl_seqlog">sl_seqlog</a>, with the result that these tables will
grow, ceaselessly, until the transaction is closed. </p></li>
</ul></div>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> You can monitor for this condition inside the database
only if the <span class="productname">PostgreSQL</span> <code class="filename"> postgresql.conf </code>
parameter <code class="envar">stats_command_string</code> is set to true.  If that
is set, then you may submit the query <code class="command"> select * from
pg_stat_activity where current_query like '%IDLE% in transaction';</code> which will find relevant activity.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> You should also be able to search for &#8220;<span class="quote"> idle in
transaction </span>&#8221; in the process table to find processes that are
thus holding on to an ancient transaction.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> It is also possible (though rarer) for the problem to
be a transaction that is, for some other reason, being held open for a
very long time.  The <code class="envar"> query_start </code> time in <code class="envar">pg_stat_activity </code> may show you some query that has been
running way too long.  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> There are plans for <span class="productname">PostgreSQL</span> to have a timeout
parameter, <code class="envar"> open_idle_transaction_timeout </code>, which would
cause old transactions to time out after some period of disuse.  Buggy
connection pool logic is a common culprit for this sort of thing.
There are plans for <span class="productname"> <a class="link" href="help.html#pgpool"> pgpool</a> </span> to provide a better alternative, eventually,
where connections would be shared inside a connection pool implemented
in C.  You may have some more or less buggy connection pool in your
Java or PHP application; if a small set of <span class="emphasis"><em> real </em></span>
connections are held in <span class="productname">pgpool</span>, that will
hide from the database the fact that the application imagines that
numerous of them are left idle in transaction for hours at a time.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="faq17"></a><a name="id2605801"></a><p><b>4.2.</b></p>
</td>
<td align="left" valign="top"><p>After dropping a node, <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>
isn't getting purged out anymore.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> This is a common scenario in versions before 1.0.5, as
the &#8220;<span class="quote">clean up</span>&#8221; that takes place when purging the node
does not include purging out old entries from the <span class="productname">Slony-I</span> table,
<a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a>, for the recently departed
node.</p>
<p> The node is no longer around to update confirmations of what
syncs have been applied on it, and therefore the cleanup thread that
purges log entries thinks that it can't safely delete entries newer
than the final <a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a> entry, which rather
curtails the ability to purge out old logs.</p>
<p>Diagnosis: Run the following query to see if there are any
&#8220;<span class="quote">phantom/obsolete/blocking</span>&#8221; <a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a> entries:

</p>
<pre class="screen">oxrsbar=# select * from _oxrsbar.sl_confirm where con_origin not in (select no_id from _oxrsbar.sl_node) or con_received not in (select no_id from _oxrsbar.sl_node);
 con_origin | con_received | con_seqno |        con_timestamp                  
------------+--------------+-----------+----------------------------
          4 |          501 |     83999 | 2004-11-09 19:57:08.195969
          1 |            2 |   3345790 | 2004-11-14 10:33:43.850265
          2 |          501 |    102718 | 2004-11-14 10:33:47.702086
        501 |            2 |      6577 | 2004-11-14 10:34:45.717003
          4 |            5 |     83999 | 2004-11-14 21:11:11.111686
          4 |            3 |     83999 | 2004-11-24 16:32:39.020194
(6 rows)</pre>
<p>In version 1.0.5, the <a class="xref" href="stmtdropnode.html" title="DROP NODE"><span class="refentrytitle">DROP NODE</span></a> function
purges out entries in <a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a> for the
departing node.  In earlier versions, this needs to be done manually.
Supposing the node number is 3, then the query would be:

</p>
<pre class="screen">delete from _namespace.sl_confirm where con_origin = 3 or con_received = 3;</pre>
<p>Alternatively, to go after &#8220;<span class="quote">all phantoms,</span>&#8221; you could use
</p>
<pre class="screen">oxrsbar=# delete from _oxrsbar.sl_confirm where con_origin not in (select no_id from _oxrsbar.sl_node) or con_received not in (select no_id from _oxrsbar.sl_node);
DELETE 6</pre>
<p>General &#8220;<span class="quote">due diligence</span>&#8221; dictates starting with a
<code class="command">BEGIN</code>, looking at the contents of
<a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a> before, ensuring that only the expected
records are purged, and then, only after that, confirming the change
with a <code class="command">COMMIT</code>.  If you delete confirm entries for
the wrong node, that could ruin your whole day.</p>
<p>You'll need to run this on each node that remains...</p>
<p>Note that as of 1.0.5, this is no longer an issue at all, as it
purges unneeded entries from <a class="xref" href="table.sl-confirm.html" title="1.3.  Table: sl_confirm">sl_confirm</a> in two
places:

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> At the time a node is dropped</p></li>
<li><p> At the start of each
<code class="function">cleanupEvent</code> run, which is the event in which old
data is purged from <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> and <a class="xref" href="table.sl-seqlog.html" title="1.13.  Table: sl_seqlog">sl_seqlog</a></p></li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2605979"></a><a name="id2605980"></a><p><b>4.3.</b></p>
</td>
<td align="left" valign="top"><p>The <span class="application">slon</span> spent the weekend out of
commission [for some reason], and it's taking a long time to get a
sync through.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> You might want to take a look at the <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>/<a class="xref" href="table.sl-log-2.html" title="1.7.  Table: sl_log_2">sl_log_2</a> tables, and
do a summary to see if there are any really enormous <span class="productname">Slony-I</span>
transactions in there.  Up until at least 1.0.2, there needs to be a
<a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> connected to the origin in order for
<code class="command">SYNC</code> events to be generated.</p>
<p>If none are being generated, then all of the updates until the
next one is generated will collect into one rather enormous <span class="productname">Slony-I</span>
transaction.</p>
<p>Conclusion: Even if there is not going to be a subscriber
around, you <span class="emphasis"><em>really</em></span> want to have a
<span class="application">slon</span> running to service the origin
node.</p>
<p><span class="productname">Slony-I</span> 1.1 provides a stored procedure that allows
<code class="command">SYNC</code> counts to be updated on the origin based on a
<span class="application">cron</span> job even if there is no <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> daemon running.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="pglistenerfull"></a><a name="id2606082"></a><p><b>4.4.</b></p>
</td>
<td align="left" valign="top">
<p>Some nodes start consistently falling behind</p>
<p>I have been running <span class="productname">Slony-I</span> on a node for a while, and am
seeing system performance suffering.</p>
<p>I'm seeing long running queries of the form:
</p>
<pre class="screen">	fetch 100 from LOG;</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> This can be characteristic of <code class="envar">pg_listener</code> (which is
the table containing <code class="command">NOTIFY</code> data) having plenty of
dead tuples in it.  That makes <code class="command">NOTIFY</code> events take a
long time, and causes the affected node to gradually fall further and
further behind.</p>
<p>You quite likely need to do a <code class="command">VACUUM FULL</code> on
<code class="envar">pg_listener</code>, to vigorously clean it out, and need to vacuum
<code class="envar">pg_listener</code> really frequently.  Once every five minutes would likely
be AOK.</p>
<p> Slon daemons already vacuum a bunch of tables, and
<code class="filename">cleanup_thread.c</code> contains a list of tables that
are frequently vacuumed automatically.  In <span class="productname">Slony-I</span> 1.0.2,
<code class="envar">pg_listener</code> is not included.  In 1.0.5 and later, it is regularly
vacuumed, so this should cease to be a direct issue.  In version 1.2,
<code class="envar">pg_listener</code> will only be used when a node is only receiving events
periodically, which means that the issue should mostly go away even in
the presence of evil long running transactions...</p>
<p>There is, however, still a scenario where this will still
&#8220;<span class="quote">bite.</span>&#8221; Under MVCC, vacuums cannot delete tuples that
were made &#8220;<span class="quote">obsolete</span>&#8221; at any time after the start time of
the eldest transaction that is still open.  Long running transactions
will cause trouble, and should be avoided, even on subscriber
nodes.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606187"></a><a name="id2606188"></a><p><b>4.5.</b></p>
</td>
<td align="left" valign="top"><p> I have submitted a <a class="xref" href="stmtmoveset.html" title="MOVE SET"><span class="refentrytitle">MOVE SET</span></a> / <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> request, and
it seems to be stuck on one of my nodes.  <span class="productname">Slony-I</span> logs aren't
displaying any errors or warnings </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Is it possible that you are running
<span class="application">pg_autovacuum</span>, and it has taken out locks
on some tables in the replication set?  That would somewhat-invisibly
block <span class="productname">Slony-I</span> from performing operations that require <a class="link" href="locking.html" title="11. Locking Issues"> acquisition of exclusive locks. </a> </p>
<p> You might check for these sorts of locks using the following
query: <code class="command"> select l.*, c.relname from pg_locks l, pg_class c
where c.oid = l.relation ; </code> A
<code class="envar">ShareUpdateExclusiveLock</code> lock will block the <span class="productname">Slony-I</span>
operations that need their own exclusive locks, which are likely
queued up, marked as not being granted. </p>
</td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqbugs"></a>5.  <span class="productname">Slony-I</span> FAQ: <span class="productname">Slony-I</span> Bugs in Elder Versions </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>5.1. <a href="faq.html#id2606277">The slon processes servicing my
subscribers are growing to enormous size, challenging system resources
both in terms of swap space as well as moving towards breaking past
the 2GB maximum process size on my system. </a>
</dt>
<dt>5.2. <a href="faq.html#faqunicode"> I am trying to replicate
UNICODE data from PostgreSQL 8.0 to PostgreSQL 8.1, and
am experiencing problems. </a>
</dt>
<dt>5.3. <a href="faq.html#id2606572"> I am running Slony-I 1.1 and have a 4+ node setup
where there are two subscription sets, 1 and 2, that do not share any
nodes.  I am discovering that confirmations for set 1 never get to the
nodes subscribing to set 2, and that confirmations for set 2 never get
to nodes subscribing to set 1.  As a result, sl_log_1 grows and grows and is never purged.  This
was reported as Slony-I bug 1485 .</a>
</dt>
<dt>5.4. <a href="faq.html#id2606660"> I am finding some multibyte columns (Unicode, Big5)
are being truncated a bit, clipping off the last character.  Why?</a>
</dt>
<dt>5.5. <a href="faq.html#sequenceset"> Bug #1226  indicates an error condition that can come up if
you have a replication set that consists solely of sequences. </a>
</dt>
<dt>5.6. <a href="faq.html#id2606758">I need to drop a table from a replication set</a>
</dt>
<dt>5.7. <a href="faq.html#id2606853">I need to drop a sequence from a replication set</a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606277"></a><a name="id2606278"></a><p><b>5.1.</b></p>
</td>
<td align="left" valign="top">
<p>The <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> processes servicing my
subscribers are growing to enormous size, challenging system resources
both in terms of swap space as well as moving towards breaking past
the 2GB maximum process size on my system. </p>
<p> By the way, the data that I am replicating includes some rather
large records.  We have records that are tens of megabytes in size.
Perhaps that is somehow relevant? </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Yes, those very large records are at the root of the
problem.  The problem is that <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> normally draws in
about 100 records at a time when a subscriber is processing the query
which loads data from the provider.  Thus, if the average record size
is 10MB, this will draw in 1000MB of data which is then transformed
into <code class="command">INSERT</code> or <code class="command">UPDATE</code>
statements, in the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> process' memory.</p>
<p> That obviously leads to <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> growing to a
fairly tremendous size. </p>
<p> The number of records that are fetched is controlled by the
value <code class="envar"> SLON_DATA_FETCH_SIZE </code>, which is defined in the
file <code class="filename">src/slon/slon.h</code>.  The relevant extract of
this is shown below. </p>
<pre class="programlisting">#ifdef	SLON_CHECK_CMDTUPLES
#define SLON_COMMANDS_PER_LINE		1
#define SLON_DATA_FETCH_SIZE		100
#define SLON_WORKLINES_PER_HELPER	(SLON_DATA_FETCH_SIZE * 4)
#else
#define SLON_COMMANDS_PER_LINE		10
#define SLON_DATA_FETCH_SIZE		10
#define SLON_WORKLINES_PER_HELPER	(SLON_DATA_FETCH_SIZE * 50)
#endif</pre>
<p> If you are experiencing this problem, you might modify the
definition of <code class="envar"> SLON_DATA_FETCH_SIZE </code>, perhaps reducing
by a factor of 10, and recompile <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a>.  There are two
definitions as <code class="envar"> SLON_CHECK_CMDTUPLES</code> allows doing some
extra monitoring to ensure that subscribers have not fallen out of
SYNC with the provider.  By default, this option is turned off, so the
default modification to make is to change the second definition of
<code class="envar"> SLON_DATA_FETCH_SIZE </code> from 10 to 1. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> In version 1.2, configuration values <a class="xref" href="slon-config-interval.html#slon-config-max-rowsize">sync_max_rowsize</a> and <a class="xref" href="slon-config-interval.html#slon-config-max-largemem">sync_max_largemem</a> are associated with a new
algorithm that changes the logic as follows.  Rather than fetching 100
rows worth of data at a time:</p>
<div class="itemizedlist"><ul type="disc">
<li><p> The <code class="command">fetch from LOG</code> query will draw
in 500 rows at a time where the size of the attributes does not exceed
<a class="xref" href="slon-config-interval.html#slon-config-max-rowsize">sync_max_rowsize</a>.  With default values, this
restricts this aspect of memory consumption to about 8MB.  </p></li>
<li><p> Tuples with larger attributes are loaded until
aggregate size exceeds the parameter <a class="xref" href="slon-config-interval.html#slon-config-max-largemem">sync_max_largemem</a>.  By default, this restricts
consumption of this sort to about 5MB.  This value is not a strict
upper bound; if you have a tuple with attributes 50MB in size, it
forcibly <span class="emphasis"><em>must</em></span> be loaded into memory.  There is no
way around that.  But <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> at least won't be trying
to load in 100 such records at a time, chewing up 10GB of memory by
the time it's done.  </p></li>
</ul></div>
<p> This should alleviate problems people have been experiencing
when they sporadically have series' of very large tuples. </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="faqunicode"></a><a name="id2606460"></a><p><b>5.2.</b></p>
</td>
<td align="left" valign="top"><p> I am trying to replicate
<code class="envar">UNICODE</code> data from <span class="productname">PostgreSQL</span> 8.0 to <span class="productname">PostgreSQL</span> 8.1, and
am experiencing problems. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> <span class="productname">PostgreSQL</span> 8.1 is quite a lot more strict about what
UTF-8 mappings of Unicode characters it accepts as compared to version
8.0.</p>
<p> If you intend to use <span class="productname">Slony-I</span> to update an older database to 8.1, and
might have invalid UTF-8 values, you may be for an unpleasant
surprise.</p>
<p> Let us suppose we have a database running 8.0, encoding in UTF-8.
That database will accept the sequence <code class="command">'\060\242'</code> as UTF-8 compliant,
even though it is really not. </p>
<p> If you replicate into a <span class="productname">PostgreSQL</span> 8.1 instance, it will complain
about this, either at subscribe time, where <span class="productname">Slony-I</span> will complain
about detecting an invalid Unicode sequence during the COPY of the
data, which will prevent the subscription from proceeding, or, upon
adding data, later, where this will hang up replication fairly much
irretrievably.  (You could hack on the contents of sl_log_1, but
that quickly gets <span class="emphasis"><em>really</em></span> unattractive...)</p>
<p>There have been discussions as to what might be done about this.  No
compelling strategy has yet emerged, as all are unattractive. </p>
<p>If you are using Unicode with <span class="productname">PostgreSQL</span> 8.0, you run a
considerable risk of corrupting data.  </p>
<p> If you use replication for a one-time conversion, there is a risk of
failure due to the issues mentioned earlier; if that happens, it
appears likely that the best answer is to fix the data on the 8.0
system, and retry. </p>
<p> In view of the risks, running replication between versions seems to be
something you should not keep running any longer than is necessary to
migrate to 8.1. </p>
<p> For more details, see the <a class="ulink" href="http://archives.postgresql.org/pgsql-hackers/2005-12/msg00181.php" target="_top">discussion on postgresql-hackers mailing list. </a>.  </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606572"></a><a name="id2606573"></a><p><b>5.3.</b></p>
</td>
<td align="left" valign="top"><p> I am running <span class="productname">Slony-I</span> 1.1 and have a 4+ node setup
where there are two subscription sets, 1 and 2, that do not share any
nodes.  I am discovering that confirmations for set 1 never get to the
nodes subscribing to set 2, and that confirmations for set 2 never get
to nodes subscribing to set 1.  As a result, <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> grows and grows and is never purged.  This
was reported as <span class="productname">Slony-I</span> <a class="ulink" href="http://gborg.postgresql.org/project/slony1/bugs/bugupdate.php?1485" target="_top">bug 1485 </a>.</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Apparently the code for
<code class="function">RebuildListenEntries()</code> does not suffice for this
case.</p>
<p> <code class="function"> RebuildListenEntries()</code> will be replaced
in <span class="productname">Slony-I</span> version 1.2 with an algorithm that covers this case. </p>
<p> In the interim, you'll want to manually add some <a class="xref" href="table.sl-listen.html" title="1.5.  Table: sl_listen">sl_listen</a> entries using <a class="xref" href="stmtstorelisten.html" title="STORE LISTEN"><span class="refentrytitle">STORE LISTEN</span></a> or <code class="function">storeListen()</code>,
based on the (apparently not as obsolete as we thought) principles
described in <a class="xref" href="listenpaths.html" title="9. Slony-I listen paths">Section 9, &#8220;Slony-I listen paths&#8221;</a>.
</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606660"></a><a name="id2606661"></a><p><b>5.4.</b></p>
</td>
<td align="left" valign="top"><p> I am finding some multibyte columns (Unicode, Big5)
are being truncated a bit, clipping off the last character.  Why?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> This was a bug present until a little after <span class="productname">Slony-I</span>
version 1.1.0; the way in which columns were being captured by the
<code class="function">logtrigger()</code> function could clip off the last
byte of a column represented in a multibyte format.  Check to see that
your version of <code class="filename">src/backend/slony1_funcs.c</code> is
1.34 or better; the patch was introduced in CVS version 1.34 of that
file.  </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="sequenceset"></a><a name="id2606697"></a><p><b>5.5.</b></p>
</td>
<td align="left" valign="top"><p> <a class="ulink" href="http://gborg.postgresql.org/project/slony1/bugs/bugupdate.php?1226" target="_top">Bug #1226 </a> indicates an error condition that can come up if
you have a replication set that consists solely of sequences. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> The  short answer is that having a replication set
consisting only of sequences is not a <a class="link" href="slonyadmin.html#bestpractices" title="1.  Slony-I Best Practices">best practice.</a> </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> The problem with a sequence-only set comes up only if you have
a case where the only subscriptions that are active for a particular
subscriber to a particular provider are for
&#8220;<span class="quote">sequence-only</span>&#8221; sets.  If a node gets into that state,
replication will fail, as the query that looks for data from <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> has no tables to find, and the query will be
malformed, and fail.  If a replication set <span class="emphasis"><em>with</em></span>
tables is added back to the mix, everything will work out fine; it
just <span class="emphasis"><em>seems</em></span> scary.</p>
<p> This problem should be resolved some time after <span class="productname">Slony-I</span>
1.1.0.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606758"></a><a name="id2606759"></a><p><b>5.6.</b></p>
</td>
<td align="left" valign="top"><p>I need to drop a table from a replication set</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p>This can be accomplished several ways, not all equally desirable ;-).

</p>
<div class="itemizedlist"><ul type="disc">
<li><p> You could drop the whole replication set, and
recreate it with just the tables that you need.  Alas, that means
recopying a whole lot of data, and kills the usability of the cluster
on the rest of the set while that's happening.</p></li>
<li><p> If you are running 1.0.5 or later, there is the
command SET DROP TABLE, which will "do the trick."</p></li>
<li>
<p> If you are still using 1.0.1 or 1.0.2, the
<span class="emphasis"><em>essential functionality of <a class="xref" href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>
involves the functionality in <code class="function">droptable_int()</code>.
You can fiddle this by hand by finding the table ID for the table you
want to get rid of, which you can find in <a class="xref" href="table.sl-table.html" title="1.18.  Table: sl_table">sl_table</a>, and then run the following three queries,
on each host:</em></span>

</p>
<pre class="programlisting">  select _slonyschema.alterTableRestore(40);
  select _slonyschema.tableDropKey(40);
  delete from _slonyschema.sl_table where tab_id = 40;</pre>
<p>The schema will obviously depend on how you defined the <span class="productname">Slony-I</span>
cluster.  The table ID, in this case, 40, will need to change to the
ID of the table you want to have go away.</p>
<p> You'll have to run these three queries on all of the nodes,
preferably firstly on the origin node, so that the dropping of this
propagates properly.  Implementing this via a <a class="xref" href="slonik.html" title="slonik"><span class="refentrytitle"><a name="app-slonik-title"></a><span class="application">slonik</span></span></a>
statement with a new <span class="productname">Slony-I</span> event would do that.  Submitting the
three queries using <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> could do that.
Also possible would be to connect to each database and submit the
queries by hand.</p>
</li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606853"></a><a name="id2606854"></a><p><b>5.7.</b></p>
</td>
<td align="left" valign="top"><p>I need to drop a sequence from a replication set</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p></p>
<p>If you are running 1.0.5 or later, there is
a <a class="xref" href="stmtsetdropsequence.html" title="SET DROP SEQUENCE"><span class="refentrytitle">SET DROP SEQUENCE</span></a> command in Slonik to allow you
to do this, parallelling <a class="xref" href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>.</p>
<p>If you are running 1.0.2 or earlier, the process is a bit more manual.</p>
<p>Supposing I want to get rid of the two sequences listed below,
<code class="envar">whois_cachemgmt_seq</code> and
<code class="envar">epp_whoi_cach_seq_</code>, we start by needing the
<code class="envar">seq_id</code> values.

</p>
<pre class="screen">oxrsorg=# select * from _oxrsorg.sl_sequence  where seq_id in (93,59);
 seq_id | seq_reloid | seq_set |       seq_comment				 
--------+------------+---------+-------------------------------------
     93 |  107451516 |       1 | Sequence public.whois_cachemgmt_seq
     59 |  107451860 |       1 | Sequence public.epp_whoi_cach_seq_
(2 rows)</pre>
<p>The data that needs to be deleted to stop Slony from continuing to
replicate these are thus:

</p>
<pre class="programlisting">delete from _oxrsorg.sl_seqlog where seql_seqid in (93, 59);
delete from _oxrsorg.sl_sequence where seq_id in (93,59);</pre>
<p>Those two queries could be submitted to all of the nodes via
<a class="xref" href="function.ddlscript-complete-integer-text-integer.html" title="1.38.  ddlscript_complete( integer, text, integer )">schemadocddlscript_complete( integer, text, integer )</a> / <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a>, thus eliminating the sequence everywhere
&#8220;<span class="quote">at once.</span>&#8221; Or they may be applied by hand to each of the
nodes.</p>
<p>Similarly to <a class="xref" href="stmtsetdroptable.html" title="SET DROP TABLE"><span class="refentrytitle">SET DROP TABLE</span></a>, this is
implemented <span class="productname">Slony-I</span> version 1.0.5 as <a class="xref" href="stmtsetdropsequence.html" title="SET DROP SEQUENCE"><span class="refentrytitle">SET DROP SEQUENCE</span></a>.</p>
</td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqobsolete"></a>6.  <span class="productname">Slony-I</span> FAQ: Hopefully Obsolete Issues </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>6.1. <a href="faq.html#id2606969"> slon does not restart after
crash</a>
</dt>
<dt>6.2. <a href="faq.html#id2607113"> I tried the following query which did not work:</a>
</dt>
<dt>6.3. <a href="faq.html#id2607245"> I can do a pg_dump
and load the data back in much faster than the SUBSCRIBE
SET runs.  Why is that?  </a>
</dt>
<dt>6.4. <a href="faq.html#dupkey">Replication Fails - Unique Constraint Violation</a>
</dt>
<dt>6.5. <a href="faq.html#id2607655">I started doing a backup using
pg_dump, and suddenly Slony
stops</a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2606969"></a><a name="id2606970"></a><p><b>6.1.</b></p>
</td>
<td align="left" valign="top">
<p> <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> does not restart after
crash</p>
<p> After an immediate stop of <span class="productname">PostgreSQL</span> (simulation of system
crash) in <code class="envar">pg_listener</code> a tuple with <code class="command">relname='_${cluster_name}_Restart'</code> exists. slon doesn't
start because it thinks another process is serving the cluster on this
node.  What can I do? The tuples can't be dropped from this
relation.</p>
<p> The logs claim that </p>
<div class="blockquote"><blockquote class="blockquote"><p>Another slon daemon is
serving this node already</p></blockquote></div>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> The problem is that the system table <code class="envar">pg_listener</code>, used
by <span class="productname">PostgreSQL</span> to manage event notifications, contains some entries
that are pointing to backends that no longer exist.  The new <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> instance connects to the database, and is convinced,
by the presence of these entries, that an old
<span class="application">slon</span> is still servicing this <span class="productname">Slony-I</span>
node.</p>
<p> The &#8220;<span class="quote">trash</span>&#8221; in that table needs to be thrown
away.</p>
<p>It's handy to keep a slonik script similar to the following to
run in such cases:

</p>
<pre class="programlisting">twcsds004[/opt/twcsds004/OXRS/slony-scripts]$ cat restart_org.slonik 
cluster name = oxrsorg ;
node 1 admin conninfo = 'host=32.85.68.220 dbname=oxrsorg user=postgres port=5532';
node 2 admin conninfo = 'host=32.85.68.216 dbname=oxrsorg user=postgres port=5532';
node 3 admin conninfo = 'host=32.85.68.244 dbname=oxrsorg user=postgres port=5532';
node 4 admin conninfo = 'host=10.28.103.132 dbname=oxrsorg user=postgres port=5532';
restart node 1;
restart node 2;
restart node 3;
restart node 4;</pre>
<p> <a class="xref" href="stmtrestartnode.html" title="RESTART NODE"><span class="refentrytitle">RESTART NODE</span></a> cleans up dead notifications
so that you can restart the node.</p>
<p>As of version 1.0.5, the startup process of slon looks for this
condition, and automatically cleans it up.</p>
<p> As of version 8.1 of <span class="productname">PostgreSQL</span>, the functions that manipulate
<code class="envar">pg_listener</code> do not support this usage, so for <span class="productname">Slony-I</span> versions after
1.1.2 (<span class="emphasis"><em>e.g. - </em></span> 1.1.5), this
&#8220;<span class="quote">interlock</span>&#8221; behaviour is handled via a new table, and the
issue should be transparently &#8220;<span class="quote">gone.</span>&#8221; </p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2607113"></a><a name="id2607114"></a><p><b>6.2.</b></p>
</td>
<td align="left" valign="top">
<p> I tried the following query which did not work:</p>
<pre class="programlisting">sdb=# explain select query_start, current_query from pg_locks join
pg_stat_activity on pid = procpid where granted = true and transaction
in (select transaction from pg_locks where granted = false); 

ERROR: could not find hash function for hash operator 716373</pre>
<p> It appears the <span class="productname">Slony-I</span> <code class="function">xxid</code> functions are
claiming to be capable of hashing, but cannot actually do so.</p>
<p> What's up? </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> defined an XXID data type and operators on
that type in order to allow manipulation of transaction IDs that are
used to group together updates that are associated with the same
transaction.</p>
<p> Operators were not available for <span class="productname">PostgreSQL</span> 7.3 and earlier
versions; in order to support version 7.3, custom functions had to be
added.  The <code class="function">=</code> operator was marked as supporting
hashing, but for that to work properly, the join operator must appear
in a hash index operator class.  That was not defined, and as a
result, queries (like the one above) that decide to use hash joins
will fail. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> This has <span class="emphasis"><em> not </em></span> been considered a
&#8220;<span class="quote">release-critical</span>&#8221; bug, as <span class="productname">Slony-I</span> does not internally
generate queries likely to use hash joins.  This problem shouldn't
injure <span class="productname">Slony-I</span>'s ability to continue replicating. </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> Future releases of <span class="productname">Slony-I</span> (<span class="emphasis"><em>e.g.</em></span>
1.0.6, 1.1) will omit the <code class="command">HASHES</code> indicator, so that</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Supposing you wish to repair an existing instance, so
that your own queries will not run afoul of this problem, you may do
so as follows: </p>
<pre class="programlisting">/* cbbrowne@[local]/dba2 slony_test1=*/ \x     
Expanded display is on.
/* cbbrowne@[local]/dba2 slony_test1=*/ select * from pg_operator where oprname = '=' 
and oprnamespace = (select oid from pg_namespace where nspname = 'public');
-[ RECORD 1 ]+-------------
oprname      | =
oprnamespace | 2200
oprowner     | 1
oprkind      | b
oprcanhash   | t
oprleft      | 82122344
oprright     | 82122344
oprresult    | 16
oprcom       | 82122365
oprnegate    | 82122363
oprlsortop   | 82122362
oprrsortop   | 82122362
oprltcmpop   | 82122362
oprgtcmpop   | 82122360
oprcode      | "_T1".xxideq
oprrest      | eqsel
oprjoin      | eqjoinsel

/* cbbrowne@[local]/dba2 slony_test1=*/ update pg_operator set oprcanhash = 'f' where 
oprname = '=' and oprnamespace = 2200 ;
UPDATE 1</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2607245"></a><a name="id2607246"></a><p><b>6.3.</b></p>
</td>
<td align="left" valign="top"><p> I can do a <code class="command">pg_dump</code>
and load the data back in much faster than the <code class="command">SUBSCRIBE
SET</code> runs.  Why is that?  </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> <span class="productname">Slony-I</span> depends on there being an already existant
index on the primary key, and leaves all indexes alone whilst using
the <span class="productname">PostgreSQL</span> <code class="command">COPY</code> command to load the data.
Further hurting performance, the <code class="command">COPY SET</code> event (an
event that the subscription process generates) starts by deleting the
contents of tables, which leaves the table full of dead tuples.</p>
<p> When you use <code class="command">pg_dump</code> to dump the contents of
a database, and then load that, creation of indexes is deferred until
the very end.  It is <span class="emphasis"><em>much</em></span> more efficient to
create indexes against the entire table, at the end, than it is to
build up the index incrementally as each row is added to the
table.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> If you can drop unnecessary indices while the
<code class="command">COPY</code> takes place, that will improve performance
quite a bit.  If you can <code class="command">TRUNCATE</code> tables that
contain data that is about to be eliminated, that will improve
performance <span class="emphasis"><em>a lot.</em></span> </p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> <span class="productname">Slony-I</span> version 1.1.5 and later versions should handle
this automatically; it &#8220;<span class="quote">thumps</span>&#8221; on the indexes in the
<span class="productname">PostgreSQL</span> catalog to hide them, in much the same way triggers are
hidden, and then &#8220;<span class="quote">fixes</span>&#8221; the index pointers and reindexes
the table. </p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="dupkey"></a><a name="id2607363"></a><p><b>6.4.</b></p>
</td>
<td align="left" valign="top">
<p>Replication Fails - Unique Constraint Violation</p>
<p>Replication has been running for a while, successfully, when a
node encounters a &#8220;<span class="quote">glitch,</span>&#8221; and replication logs are filled with
repetitions of the following:

</p>
<pre class="screen">DEBUG2 remoteWorkerThread_1: syncing set 2 with 5 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 1 with 41 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 5 with 1 table(s) from provider 1
DEBUG2 remoteWorkerThread_1: syncing set 3 with 1 table(s) from provider 1
DEBUG2 remoteHelperThread_1_1: 0.135 seconds delay for first row
DEBUG2 remoteHelperThread_1_1: 0.343 seconds until close cursor
ERROR  remoteWorkerThread_1: "insert into "_oxrsapp".sl_log_1          (log_origin, log_xid, log_tableid,                log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '34', '35090538', 'D', '_rserv_ts=''9275244''');
delete from only public.epp_domain_host where _rserv_ts='9275244';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '34', '35090539', 'D', '_rserv_ts=''9275245''');
delete from only public.epp_domain_host where _rserv_ts='9275245';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090540', 'D', '_rserv_ts=''24240590''');
delete from only public.epp_domain_contact where _rserv_ts='24240590';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090541', 'D', '_rserv_ts=''24240591''');
delete from only public.epp_domain_contact where _rserv_ts='24240591';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '26', '35090542', 'D', '_rserv_ts=''24240589''');
delete from only public.epp_domain_contact where _rserv_ts='24240589';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '11', '35090543', 'D', '_rserv_ts=''36968002''');
delete from only public.epp_domain_status where _rserv_ts='36968002';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '11', '35090544', 'D', '_rserv_ts=''36968003''');
delete from only public.epp_domain_status where _rserv_ts='36968003';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090549', 'I', '(contact_id,status,reason,_rserv_ts) values (''6972897'',''64'','''',''31044208'')');
insert into public.contact_status (contact_id,status,reason,_rserv_ts) values ('6972897','64','','31044208');insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090550', 'D', '_rserv_ts=''18139332''');
delete from only public.contact_status where _rserv_ts='18139332';insert into "_oxrsapp".sl_log_1	  (log_origin, log_xid, log_tableid,		log_actionseq, log_cmdtype,		log_cmddata) values	  ('1', '919151224', '24', '35090551', 'D', '_rserv_ts=''18139333''');
delete from only public.contact_status where _rserv_ts='18139333';" ERROR:  duplicate key violates unique constraint "contact_status_pkey"
 - qualification was: 
ERROR  remoteWorkerThread_1: SYNC aborted</pre>
<p>The transaction rolls back, and
<span class="productname">Slony-I</span> tries again, and again, and again.
The problem is with one of the <span class="emphasis"><em>last</em></span> SQL
statements, the one with <code class="command">log_cmdtype = 'I'</code>.  That
isn't quite obvious; what takes place is that
<span class="productname">Slony-I</span> groups 10 update queries together
to diminish the number of network round trips.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> A <span class="emphasis"><em>certain</em></span> cause for this has been
difficult to arrive at.</p>
<p>By the time we notice that there is a problem, the seemingly
missed delete transaction has been cleaned out of <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>, so there appears to be no recovery
possible.  What has seemed necessary, at this point, is to drop the
replication set (or even the node), and restart replication from
scratch on that node.</p>
<p>In <span class="productname">Slony-I</span> 1.0.5, the handling of purges of <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> became more conservative, refusing to purge
entries that haven't been successfully synced for at least 10 minutes
on all nodes.  It was not certain that that would prevent the
&#8220;<span class="quote">glitch</span>&#8221; from taking place, but it seemed plausible that
it might leave enough <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> data to be able
to do something about recovering from the condition or at least
diagnosing it more exactly.  And perhaps the problem was that <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> was being purged too aggressively, and this
would resolve the issue completely.</p>
<p> It is a shame to have to reconstruct a large replication node
for this; if you discover that this problem recurs, it may be an idea
to break replication down into multiple sets in order to diminish the
work involved in restarting replication.  If only one set has broken,
you may only need to unsubscribe/drop and resubscribe the one set.</p>
<p> In one case we found two lines in the SQL error message in the
log file that contained <span class="emphasis"><em> identical </em></span> insertions
into <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>.  This <span class="emphasis"><em> ought</em></span> to be impossible as is a primary key on <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>.  The latest (somewhat) punctured theory
that comes from <span class="emphasis"><em>that</em></span> was that perhaps this PK
index has been corrupted (representing a <span class="productname">PostgreSQL</span> bug), and that
perhaps the problem might be alleviated by running the query:</p>
<pre class="programlisting"># reindex table _slonyschema.sl_log_1;</pre>
<p> On at least one occasion, this has resolved the problem, so it
is worth trying this.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top"><p> This problem has been found to represent a <span class="productname">PostgreSQL</span>
bug as opposed to one in <span class="productname">Slony-I</span>.  Version 7.4.8 was released with
two resolutions to race conditions that should resolve the issue.
Thus, if you are running a version of <span class="productname">PostgreSQL</span> earlier than 7.4.8,
you should consider upgrading to resolve this.</p></td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2607655"></a><a name="id2607656"></a><p><b>6.5.</b></p>
</td>
<td align="left" valign="top"><p>I started doing a backup using
<span class="application">pg_dump</span>, and suddenly Slony
stops</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p>Ouch.  What happens here is a conflict between:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> <span class="application">pg_dump</span>, which has taken
out an <code class="command">AccessShareLock</code> on all of the tables in the
database, including the <span class="productname">Slony-I</span> ones, and</p></li>
<li><p> A <span class="productname">Slony-I</span> sync event, which wants to grab a
<code class="command">AccessExclusiveLock</code> on the table <a class="xref" href="table.sl-event.html" title="1.4.  Table: sl_event">sl_event</a>.</p></li>
</ul></div>
<p>The initial query that will be blocked is thus:

</p>
<pre class="screen">select "_slonyschema".createEvent('_slonyschema, 'SYNC', NULL);	  </pre>
<p>(You can see this in <code class="envar">pg_stat_activity</code>, if you
have query display turned on in
<code class="filename">postgresql.conf</code>)</p>
<p>The actual query combination that is causing the lock is from
the function <code class="function">Slony_I_ClusterStatus()</code>, found in
<code class="filename">slony1_funcs.c</code>, and is localized in the code that
does:

</p>
<pre class="programlisting">  LOCK TABLE %s.sl_event;
  INSERT INTO %s.sl_event (...stuff...)
  SELECT currval('%s.sl_event_seq');</pre>
<p>The <code class="command">LOCK</code> statement will sit there and wait
until <code class="command">pg_dump</code> (or whatever else has pretty much any
kind of access lock on <a class="xref" href="table.sl-event.html" title="1.4.  Table: sl_event">sl_event</a>)
completes.</p>
<p>Every subsequent query submitted that touches
<a class="xref" href="table.sl-event.html" title="1.4.  Table: sl_event">sl_event</a> will block behind the
<code class="function">createEvent</code> call.</p>
<p>There are a number of possible answers to this:
</p>
<div class="itemizedlist"><ul type="disc">
<li><p> Have <span class="application">pg_dump</span> specify the
schema dumped using <code class="option">--schema=whatever</code>, and don't try
dumping the cluster's schema.</p></li>
<li><p> It would be nice to add an
<code class="option">--exclude-schema</code> option to
<span class="application">pg_dump</span> to exclude the <span class="productname">Slony-I</span> cluster
schema.  Maybe in 8.2...</p></li>
<li><p>Note that 1.0.5 uses a more precise lock that is less
exclusive that alleviates this problem.</p></li>
</ul></div>
</td>
</tr>
<tr class="qandadiv"><td align="left" valign="top" colspan="2"><h3 class="title">
<a name="faqoddities"></a>7.  <span class="productname">Slony-I</span> FAQ: Oddities and Heavy Slony-I Hacking </h3></td></tr>
<tr class="toc"><td align="left" valign="top" colspan="2"><dl>
<dt>7.1. <a href="faq.html#id2607855"> What happens with rules and triggers on
Slony-I-replicated tables?</a>
</dt>
<dt>7.2. <a href="faq.html#id2608031"> I was trying to request EXECUTE SCRIPT or MOVE SET, and found
messages as follows on one of the subscribers:</a>
</dt>
<dt>7.3. <a href="faq.html#neededexecddl"> Behaviour - all the subscriber nodes start to fall
behind the origin, and all the logs on the subscriber nodes have the
following error message repeating in them (when I encountered it,
there was a nice long SQL statement above each entry):</a>
</dt>
<dt>7.4. <a href="faq.html#id2608285"> Node #1 was dropped via DROP NODE, and the slon one of the
other nodes is repeatedly failing with the error message:</a>
</dt>
</dl></td></tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2607855"></a><a name="id2607856"></a><p><b>7.1.</b></p>
</td>
<td align="left" valign="top"><p> What happens with rules and triggers on
<span class="productname">Slony-I</span>-replicated tables?</p></td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Firstly, let's look at how it is handled
<span class="emphasis"><em>absent</em></span> of the special handling of the <a class="xref" href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a> Slonik command.  </p>
<p> The function <a class="xref" href="function.altertableforreplication-integer.html" title="1.23.  altertableforreplication( integer )">schemadocaltertableforreplication( integer )</a> prepares each
table for replication.</p>
<div class="itemizedlist"><ul type="disc">
<li>
<p> On the origin node, this involves adding a trigger
that uses the <a class="xref" href="function.logtrigger.html" title="1.78.  logtrigger( )">schemadoc.logtrigger(  )</a> function to the
table.</p>
<p> That trigger initiates the action of logging all updates to the
table to <span class="productname">Slony-I</span> <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a>
tables.</p>
</li>
<li>
<p> On a subscriber node, this involves disabling
triggers and rules, then adding in the trigger that denies write
access using the <code class="function">denyAccess()</code> function to
replicated tables.</p>
<p> Up until 1.1 (and perhaps onwards), the
&#8220;<span class="quote">disabling</span>&#8221; is done by modifying the
<code class="envar">pg_trigger</code> or <code class="envar">pg_rewrite</code>
<code class="envar">tgrelid</code> to point to the OID of the &#8220;<span class="quote">primary
key</span>&#8221; index on the table rather than to the table
itself.</p>
</li>
</ul></div>
<p> A somewhat unfortunate side-effect is that this handling of the
rules and triggers somewhat &#8220;<span class="quote">tramples</span>&#8221; on them.  The
rules and triggers are still there, but are no longer properly tied to
their tables.  If you do a <code class="command">pg_dump</code> on the
&#8220;<span class="quote">subscriber</span>&#8221; node, it won't find the rules and triggers
because it does not expect them to be associated with an index.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Now, consider how <a class="xref" href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a>
enters into things.</p>
<p> Simply put, this command causes
<span class="productname">Slony-I</span> to restore the trigger using
<code class="function">alterTableRestore(table id)</code>, which restores the
table's OID into the <code class="envar">pg_trigger</code> or
<code class="envar">pg_rewrite</code> <code class="envar">tgrelid</code> column on the
affected node.</p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> This implies that if you plan to draw backups from a
subscriber node, you will need to draw the schema from the origin
node.  It is straightforward to do this: </p>
<pre class="screen">% pg_dump -h originnode.example.info -p 5432 --schema-only --schema=public ourdb &gt; schema_backup.sql
% pg_dump -h subscribernode.example.info -p 5432 --data-only --schema=public ourdb &gt; data_backup.sql</pre>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2608031"></a><a name="id2608032"></a><p><b>7.2.</b></p>
</td>
<td align="left" valign="top">
<p> I was trying to request <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> or <a class="xref" href="stmtmoveset.html" title="MOVE SET"><span class="refentrytitle">MOVE SET</span></a>, and found
messages as follows on one of the subscribers:</p>
<pre class="screen">NOTICE: Slony-I: multiple instances of trigger defrazzle on table frobozz
NOTICE: Slony-I: multiple instances of trigger derez on table tron
ERROR: Slony-I: Unable to disable triggers</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> The trouble would seem to be that you have added
triggers on tables whose names conflict with triggers that were hidden
by <span class="productname">Slony-I</span>. </p>
<p> <span class="productname">Slony-I</span> hides triggers (save for those &#8220;<span class="quote">unhidden</span>&#8221;
via <a class="xref" href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a>) by repointing them to the
primary key of the table.  In the case of foreign key triggers, or
other triggers used to do data validation, it should be quite
unnecessary to run them on a subscriber, as equivalent triggers should
have been invoked on the origin node.  In contrast, triggers that do
some form of &#8220;<span class="quote">cache invalidation</span>&#8221; are ones you might want
to have run on a subscriber.</p>
<p> The <span class="emphasis"><em>Right Way</em></span> to handle such triggers is
normally to use <a class="xref" href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a>, which tells
<span class="productname">Slony-I</span> that a trigger should not get deactivated. </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> But some intrepid DBA might take matters into their
own hands and install a trigger by hand on a subscriber, and the above
condition generally has that as the cause.  What to do?  What to do?</p>
<p> The answer is normally fairly simple: Drop out the
&#8220;<span class="quote">extra</span>&#8221; trigger on the subscriber before the event that
tries to restore them runs.  Ideally, if the DBA is particularly
intrepid, and aware of this issue, that should take place
<span class="emphasis"><em>before</em></span> there is ever a chance for the error
message to appear.  </p>
<p> If the DBA is not that intrepid, the answer is to connect to
the offending node and drop the &#8220;<span class="quote">visible</span>&#8221; version of the
trigger using the <acronym class="acronym">SQL</acronym> <code class="command">DROP
TRIGGER</code> command.  That should allow the event to proceed.
If the event was <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a>, then the
&#8220;<span class="quote">not-so-intrepid</span>&#8221; DBA may need to add the trigger back,
by hand, or, if they are wise, they should consider activating it
using <a class="xref" href="stmtstoretrigger.html" title="STORE TRIGGER"><span class="refentrytitle">STORE TRIGGER</span></a>.</p>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="neededexecddl"></a><a name="id2608176"></a><p><b>7.3.</b></p>
</td>
<td align="left" valign="top">
<p> Behaviour - all the subscriber nodes start to fall
behind the origin, and all the logs on the subscriber nodes have the
following error message repeating in them (when I encountered it,
there was a nice long SQL statement above each entry):</p>
<pre class="screen">ERROR remoteWorkerThread_1: helper 1 finished with error
ERROR remoteWorkerThread_1: SYNC aborted</pre>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"></td>
<td align="left" valign="top">
<p> Cause: you have likely issued <code class="command">alter
table</code> statements directly on the databases instead of using
the slonik <a class="xref" href="stmtddlscript.html" title="EXECUTE SCRIPT"><span class="refentrytitle">EXECUTE SCRIPT</span></a> command.</p>
<p>The solution is to rebuild the trigger on the affected table and
fix the entries in <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> by hand.</p>
<div class="itemizedlist"><ul type="disc">
<li><p> You'll need to identify from either the slon logs, or
the <span class="productname">PostgreSQL</span> database logs exactly which statement it is that is
causing the error.</p></li>
<li>
<p> You need to fix the Slony-defined triggers on the
table in question.  This is done with the following procedure.</p>
<pre class="screen">BEGIN;
LOCK TABLE table_name;
SELECT _oxrsorg.altertablerestore(tab_id);--tab_id is _slony_schema.sl_table.tab_id
SELECT _oxrsorg.altertableforreplication(tab_id);--tab_id is _slony_schema.sl_table.tab_id
COMMIT;</pre>
<p>You then need to find the rows in <a class="xref" href="table.sl-log-1.html" title="1.6.  Table: sl_log_1">sl_log_1</a> that have bad 
entries and fix them.  You may
want to take down the slon daemons for all nodes except the master;
that way, if you make a mistake, it won't immediately propagate
through to the subscribers.</p>
<p> Here is an example:</p>
<pre class="screen">BEGIN;

LOCK TABLE customer_account;

SELECT _app1.altertablerestore(31);
SELECT _app1.altertableforreplication(31);
COMMIT;

BEGIN;
LOCK TABLE txn_log;

SELECT _app1.altertablerestore(41);
SELECT _app1.altertableforreplication(41);

COMMIT;

--fixing customer_account, which had an attempt to insert a "" into a timestamp with timezone.
BEGIN;

update _app1.sl_log_1 SET log_cmddata = 'balance=''60684.00'' where pkey=''49''' where log_actionseq = '67796036';
update _app1.sl_log_1 SET log_cmddata = 'balance=''60690.00'' where pkey=''49''' where log_actionseq = '67796194';
update _app1.sl_log_1 SET log_cmddata = 'balance=''60684.00'' where pkey=''49''' where log_actionseq = '67795881';
update _app1.sl_log_1 SET log_cmddata = 'balance=''1852.00'' where pkey=''57''' where log_actionseq = '67796403';
update _app1.sl_log_1 SET log_cmddata = 'balance=''87906.00'' where pkey=''8''' where log_actionseq = '68352967';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125180.00'' where pkey=''60''' where log_actionseq = '68386951';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125198.00'' where pkey=''60''' where log_actionseq = '68387055';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125174.00'' where pkey=''60''' where log_actionseq = '68386682';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125186.00'' where pkey=''60''' where log_actionseq = '68386992';
update _app1.sl_log_1 SET log_cmddata = 'balance=''125192.00'' where pkey=''60''' where log_actionseq = '68387029';
</pre>
</li>
</ul></div>
</td>
</tr>
<tr class="question">
<td align="left" valign="top">
<a name="id2608285"></a><a name="id2608286"></a><p><b>7.4.</b></p>
</td>
<td align="left" valign="top">
<p> Node #1 was dropped via <a class="xref" href="stmtdropnode.html" title="DROP NODE"><span class="refentrytitle">DROP NODE</span></a>, and the <a class="xref" href="slon.html" title="slon"><span class="refentrytitle"><a name="app-slon-title"></a><span class="application">slon</span></span></a> one of the
other nodes is repeatedly failing with the error message:</p>
<pre class="screen">ERROR  remoteWorkerThread_3: "begin transaction; set transaction isolation level
 serializable; lock table "_mailermailer".sl_config_lock; select "_mailermailer"
.storeListen_int(2, 1, 3); notify "_mailermailer_Event"; notify "_mailermailer_C
onfirm"; insert into "_mailermailer".sl_event     (ev_origin, ev_seqno, ev_times
tamp,      ev_minxid, ev_maxxid, ev_xip, ev_type , ev_data1, ev_data2, ev_data3
   ) values ('3', '2215', '2005-02-18 10:30:42.529048', '3286814', '3286815', ''
, 'STORE_LISTEN', '2', '1', '3'); insert into "_mailermailer".sl_confirm
(con_origin, con_received, con_seqno, con_timestamp)    values (3, 2, '2215', CU
RRENT_TIMESTAMP); commit transaction;" PGRES_FATAL_ERROR ERROR:  insert or updat
e on table "sl_listen" violates foreign key constraint "sl_listen-sl_path-ref"
DETAIL:  Key (li_provider,li_receiver)=(1,3) is not present in table "sl_path".
DEBUG1 syncThread: thread done</pre>
<p> Evidently, a <a class="xref" href="stmtstorelisten.html" title="STORE LISTEN"><span class="refentrytitle">STORE LISTEN</span></a> request hadn't
propagated yet before node 1 was dropped.  </p>
</td>
</tr>
<tr class="answer">
<td align="left" valign="top"><a name="eventsurgery"></a></td>
<td align="left" valign="top">
<p> This points to a case where you'll
need to do &#8220;<span class="quote">event surgery</span>&#8221; on one or more of the nodes.
A <code class="command">STORE_LISTEN</code> event remains outstanding that wants
to add a listen path that <span class="emphasis"><em>cannot</em></span> be created
because node 1 and all paths pointing to node 1 have gone away.</p>
<p> Let's assume, for exposition purposes, that the remaining nodes
are #2 and #3, and that the above error is being reported on node
#3.</p>
<p> That implies that the event is stored on node #2, as it
wouldn't be on node #3 if it had not already been processed
successfully.  The easiest way to cope with this situation is to
delete the offending <a class="xref" href="table.sl-event.html" title="1.4.  Table: sl_event">sl_event</a> entry on node #2.
You'll connect to node #2's database, and search for the
<code class="command">STORE_LISTEN</code> event:</p>
<p> <code class="command"> select * from sl_event where ev_type =
'STORE_LISTEN';</code></p>
<p> There may be several entries, only some of which need to be
purged. </p>
<pre class="screen"> 
-# begin;  -- Don't straight delete them; open a transaction so you can respond to OOPS
BEGIN;
-# delete from sl_event where ev_type = 'STORE_LISTEN' and
-#  (ev_data1 = '1' or ev_data2 = '1' or ev_data3 = '1');
DELETE 3
-# -- Seems OK...
-# commit;
COMMIT</pre>
<p> The next time the <span class="application">slon</span> for node 3
starts up, it will no longer find the &#8220;<span class="quote">offensive</span>&#8221;
<code class="command">STORE_LISTEN</code> events, and replication can continue.
(You may then run into some other problem where an old stored event is
referring to no-longer-existant configuration...) </p>
</td>
</tr>
</tbody>
</table>
</div>
</div></body>
</html>
