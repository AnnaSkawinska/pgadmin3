<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>29.9. Error Handling</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="PostgreSQL 8.0.2 Documentation">
<link rel="up" href="ecpg.html" title="Chapter 29. ECPG - Embedded SQL in C">
<link rel="previous" href="ecpg-descriptors.html" title="29.8. Using SQL Descriptor Areas">
<link rel="next" href="ecpg-include.html" title="29.10. Including Files">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="ecpg-errors"></a>29.9. Error Handling</h2></div></div>
<div></div>
</div>
<p>   This section describes how you can handle exceptional conditions
   and warnings in an embedded SQL program.  There are several
   nonexclusive facilities for this.
  </p>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="id2620251"></a>29.9.1. Setting Callbacks</h3></div></div>
<div></div>
</div>
<p>    One simple method to catch errors and warnings is to set a
    specific action to be executed whenever a particular condition
    occurs.  In general:
</p>
<pre class="programlisting">EXEC SQL WHENEVER <i class="replaceable"><tt>condition</tt></i> <i class="replaceable"><tt>action</tt></i>;</pre>
<p>
   </p>
<p>    <i class="replaceable"><tt>condition</tt></i> can be one of the following:

    </p>
<div class="variablelist"><dl>
<dt><span class="term"><tt class="literal">SQLERROR</tt></span></dt>
<dd><p>        The specified action is called whenever an error occurs during
        the execution of an SQL statement.
       </p></dd>
<dt><span class="term"><tt class="literal">SQLWARNING</tt></span></dt>
<dd><p>        The specified action is called whenever a warning occurs
        during the execution of an SQL statement.
       </p></dd>
<dt><span class="term"><tt class="literal">NOT FOUND</tt></span></dt>
<dd><p>        The specified action is called whenever an SQL statement
        retrieves or affects zero rows.  (This condition is not an
        error, but you might be interested in handling it specially.)
       </p></dd>
</dl></div>
<p>
   </p>
<p>    <i class="replaceable"><tt>action</tt></i> can be one of the following:

    </p>
<div class="variablelist"><dl>
<dt><span class="term"><tt class="literal">CONTINUE</tt></span></dt>
<dd><p>        This effectively means that the condition is ignored.  This is
        the default.
       </p></dd>
<dt>
<span xmlns="http://www.w3.org/TR/xhtml1/transitional" class="term"><tt xmlns="" class="literal">GOTO <i class="replaceable"><tt>label</tt></i></tt></span><br xmlns="http://www.w3.org/TR/xhtml1/transitional"></br><span class="term"><tt class="literal">GO TO <i class="replaceable"><tt>label</tt></i></tt></span>
</dt>
<dd><p>        Jump to the specified label (using a C <tt class="literal">goto</tt>
        statement).
       </p></dd>
<dt><span class="term"><tt class="literal">SQLPRINT</tt></span></dt>
<dd><p>        Print a message to standard error.  This is useful for simple
        programs or during prototyping.  The details of the message
        cannot be configured.
       </p></dd>
<dt><span class="term"><tt class="literal">STOP</tt></span></dt>
<dd><p>        Call <tt class="literal">exit(1)</tt>, which will terminate the
        program.
       </p></dd>
<dt><span class="term"><tt class="literal">BREAK</tt></span></dt>
<dd><p>        Execute the C statement <tt class="literal">break</tt>.  This should
        only be used in loops or <tt class="literal">switch</tt> statements.
       </p></dd>
<dt>
<span xmlns="http://www.w3.org/TR/xhtml1/transitional" class="term"><tt xmlns="" class="literal">CALL <i class="replaceable"><tt>name</tt></i> (<i class="replaceable"><tt>args</tt></i>)</tt></span><br xmlns="http://www.w3.org/TR/xhtml1/transitional"></br><span class="term"><tt class="literal">DO <i class="replaceable"><tt>name</tt></i> (<i class="replaceable"><tt>args</tt></i>)</tt></span>
</dt>
<dd><p>        Call the specified C functions with the specified arguments.
       </p></dd>
</dl></div>
<p>

    The SQL standard only provides for the actions
    <tt class="literal">CONTINUE</tt> and <tt class="literal">GOTO</tt> (and
    <tt class="literal">GO TO</tt>).
   </p>
<p>    Here is an example that you might want to use in a simple program.
    It prints a simple message when a warning occurs and aborts the
    program when an error happens.
</p>
<pre class="programlisting">EXEC SQL WHENEVER SQLWARNING SQLPRINT;
EXEC SQL WHENEVER SQLERROR STOP;</pre>
<p>
   </p>
<p>    The statement <tt class="literal">EXEC SQL WHENEVER</tt> is a directive
    of the SQL preprocessor, not a C statement.  The error or warning
    actions that it sets apply to all embedded SQL statements that
    appear below the point where the handler is set, unless a
    different action was set for the same condition between the first
    <tt class="literal">EXEC SQL WHENEVER</tt> and the SQL statement causing
    the condition, regardless of the flow of control in the C program.
    So neither of the two following C program excerpts will have the
    desired effect.
</p>
<pre class="programlisting">/*
 * WRONG
 */
int main(int argc, char *argv[])
{
    ...
    if (verbose) {
        EXEC SQL WHENEVER SQLWARNING SQLPRINT;
    }
    ...
    EXEC SQL SELECT ...;
    ...
}</pre>
<p>

</p>
<pre class="programlisting">/*
 * WRONG
 */
int main(int argc, char *argv[])
{
    ...
    set_error_handler();
    ...
    EXEC SQL SELECT ...;
    ...
}

static void set_error_handler(void)
{
    EXEC SQL WHENEVER SQLERROR STOP;
}</pre>
<p>
   </p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="id2620523"></a>29.9.2. sqlca</h3></div></div>
<div></div>
</div>
<p>    For more powerful error handling, the embedded SQL interface
    provides a global variable with the name <tt class="varname">sqlca</tt>
    that has the following structure:
</p>
<pre class="programlisting">struct
{
    char sqlcaid[8];
    long sqlabc;
    long sqlcode;
    struct
    {
        int sqlerrml;
        char sqlerrmc[70];
    } sqlerrm;
    char sqlerrp[8];
    long sqlerrd[6];
    char sqlwarn[8];
    char sqlstate[5];
} sqlca;</pre>
<p>
    (In a multithreaded program, every thread automatically gets its
    own copy of <tt class="varname">sqlca</tt>.  This works similarly to the
    handling of the standard C global variable
    <tt class="varname">errno</tt>.)
   </p>
<p>    <tt class="varname">sqlca</tt> covers both warnings and errors.  If
    multiple warnings or errors occur during the execution of a
    statement, then <tt class="varname">sqlca</tt> will only contain
    information about the last one.
   </p>
<p>    If no error occurred in the last <span class="acronym">SQL</span> statement,
    <tt class="literal">sqlca.sqlcode</tt> will be 0 and
    <tt class="literal">sqlca.sqlstate</tt> will be
    <tt class="literal">"00000"</tt>.  If a warning or error occurred, then
    <tt class="literal">sqlca.sqlcode</tt> will be negative and
    <tt class="literal">sqlca.sqlstate</tt> will be different from
    <tt class="literal">"00000"</tt>.  A positive
    <tt class="literal">sqlca.sqlcode</tt> indicates a harmless condition,
    such as that the last query returned zero rows.
    <tt class="literal">sqlcode</tt> and <tt class="literal">sqlstate</tt> are two
    different error code schemes; details appear below.
   </p>
<p>    If the last SQL statement was successful, then
    <tt class="literal">sqlca.sqlerrd[1]</tt> contains the OID of the
    processed row, if applicable, and
    <tt class="literal">sqlca.sqlerrd[2]</tt> contains the number of
    processed or returned rows, if applicable to the command.
   </p>
<p>    In case of an error or warning,
    <tt class="literal">sqlca.sqlerrm.sqlerrmc</tt> will contain a string
    that describes the error.  The field
    <tt class="literal">sqlca.sqlerrm.sqlerrml</tt> contains the length of
    the error message that is stored in
    <tt class="literal">sqlca.sqlerrm.sqlerrmc</tt> (the result of
    <tt class="function">strlen()</tt>, not really interesting for a C
    programmer).  Note that some messages are too long to fit in the
    fixed-size <tt class="literal">sqlerrmc</tt> array; they will be truncated.
   </p>
<p>    In case of a warning, <tt class="literal">sqlca.sqlwarn[2]</tt> is set
    to <tt class="literal">W</tt>.  (In all other cases, it is set to
    something different from <tt class="literal">W</tt>.)  If
    <tt class="literal">sqlca.sqlwarn[1]</tt> is set to
    <tt class="literal">W</tt>, then a value was truncated when it was
    stored in a host variable.  <tt class="literal">sqlca.sqlwarn[0]</tt> is
    set to <tt class="literal">W</tt> if any of the other elements are set
    to indicate a warning.
   </p>
<p>    The fields <tt class="structfield">sqlcaid</tt>,
    <tt class="structfield">sqlcabc</tt>,
    <tt class="structfield">sqlerrp</tt>, and the remaining elements of
    <tt class="structfield">sqlerrd</tt> and
    <tt class="structfield">sqlwarn</tt> currently contain no useful
    information.
   </p>
<p>    The structure <tt class="varname">sqlca</tt> is not defined in the SQL
    standard, but is implemented in several other SQL database
    systems.  The definitions are similar at the core, but if you want
    to write portable applications, then you should investigate the
    different implementations carefully.
   </p>
</div>
<div class="sect2" lang="en">
<div class="titlepage">
<div><div><h3 class="title">
<a name="id2620769"></a>29.9.3. <tt class="literal">SQLSTATE</tt> vs <tt class="literal">SQLCODE</tt></h3></div></div>
<div></div>
</div>
<p>    The fields <tt class="literal">sqlca.sqlstate</tt> and
    <tt class="literal">sqlca.sqlcode</tt> are two different schemes that
    provide error codes.  Both are specified in the SQL standard, but
    <tt class="literal">SQLCODE</tt> has been marked deprecated in the 1992
    edition of the standard and has been dropped in the 1999 edition.
    Therefore, new applications are strongly encouraged to use
    <tt class="literal">SQLSTATE</tt>.
   </p>
<p>    <tt class="literal">SQLSTATE</tt> is a five-character array.  The five
    characters contain digits or upper-case letters that represent
    codes of various error and warning conditions.
    <tt class="literal">SQLSTATE</tt> has a hierarchical scheme: the first
    two characters indicate the general class of the condition, the
    last three characters indicate a subclass of the general
    condition.  A successful state is indicated by the code
    <tt class="literal">00000</tt>.  The <tt class="literal">SQLSTATE</tt> codes are for
    the most part defined in the SQL standard.  The
    <span class="productname">PostgreSQL</span> server natively supports
    <tt class="literal">SQLSTATE</tt> error codes; therefore a high degree
    of consistency can be achieved by using this error code scheme
    throughout all applications.  For further information see
    <a href="errcodes-appendix.html" title="Appendix A. PostgreSQL Error Codes">Appendix A, <i>PostgreSQL Error Codes</i></a>.
   </p>
<p>    <tt class="literal">SQLCODE</tt>, the deprecated error code scheme, is a
    simple integer.  A value of 0 indicates success, a positive value
    indicates success with additional information, a negative value
    indicates an error.  The SQL standard only defines the positive
    value +100, which indicates that the last command returned or
    affected zero rows, and no specific negative values.  Therefore,
    this scheme can only achieve poor portability and does not have a
    hierarchical code assignment.  Historically, the embedded SQL
    processor for <span class="productname">PostgreSQL</span> has assigned
    some specific <tt class="literal">SQLCODE</tt> values for its use, which
    are listed below with their numeric value and their symbolic name.
    Remember that these are not portable to other SQL implementations.
    To simplify the porting of applications to the
    <tt class="literal">SQLSTATE</tt> scheme, the corresponding
    <tt class="literal">SQLSTATE</tt> is also listed.  There is, however, no
    one-to-one or one-to-many mapping between the two schemes (indeed
    it is many-to-many), so you should consult the global
    <tt class="literal">SQLSTATE</tt> listing in <a href="errcodes-appendix.html" title="Appendix A. PostgreSQL Error Codes">Appendix A, <i>PostgreSQL Error Codes</i></a>
    in each case.
   </p>
<p>    These are the assigned <tt class="literal">SQLCODE</tt> values:

    </p>
<div class="variablelist"><dl>
<dt><span class="term">-12 (<tt class="symbol">ECPG_OUT_OF_MEMORY</tt>)</span></dt>
<dd><p>        Indicates that your virtual memory is exhausted. (SQLSTATE
        YE001)
      </p></dd>
<dt><span class="term">-200 (<tt class="symbol">ECPG_UNSUPPORTED</tt>)</span></dt>
<dd><p>       Indicates the preprocessor has generated something that the
       library does not know about.  Perhaps you are running
       incompatible versions of the preprocessor and the
       library. (SQLSTATE YE002)
      </p></dd>
<dt><span class="term">-201 (<tt class="symbol">ECPG_TOO_MANY_ARGUMENTS</tt>)</span></dt>
<dd><p>       This means that the command specified more host variables than
       the command expected.  (SQLSTATE 07001 or 07002)
      </p></dd>
<dt><span class="term">-202 (<tt class="symbol">ECPG_TOO_FEW_ARGUMENTS</tt>)</span></dt>
<dd><p>       This means that the command specified fewer host variables than
       the command expected.  (SQLSTATE 07001 or 07002)
      </p></dd>
<dt><span class="term">-203 (<tt class="symbol">ECPG_TOO_MANY_MATCHES</tt>)</span></dt>
<dd><p>       This means a query has returned multiple rows but the statement
       was only prepared to store one result row (for example, because
       the specified variables are not arrays).  (SQLSTATE 21000)
      </p></dd>
<dt><span class="term">-204 (<tt class="symbol">ECPG_INT_FORMAT</tt>)</span></dt>
<dd><p>       The host variable is of type <tt class="type">int</tt> and the datum in
       the database is of a different type and contains a value that
       cannot be interpreted as an <tt class="type">int</tt>.  The library uses
       <tt class="function">strtol()</tt> for this conversion.  (SQLSTATE
       42804)
      </p></dd>
<dt><span class="term">-205 (<tt class="symbol">ECPG_UINT_FORMAT</tt>)</span></dt>
<dd><p>       The host variable is of type <tt class="type">unsigned int</tt> and the
       datum in the database is of a different type and contains a
       value that cannot be interpreted as an <tt class="type">unsigned
       int</tt>.  The library uses <tt class="function">strtoul()</tt>
       for this conversion.  (SQLSTATE 42804)
      </p></dd>
<dt><span class="term">-206 (<tt class="symbol">ECPG_FLOAT_FORMAT</tt>)</span></dt>
<dd><p>       The host variable is of type <tt class="type">float</tt> and the datum
       in the database is of another type and contains a value that
       cannot be interpreted as a <tt class="type">float</tt>.  The library
       uses <tt class="function">strtod()</tt> for this conversion.
       (SQLSTATE 42804)
      </p></dd>
<dt><span class="term">-207 (<tt class="symbol">ECPG_CONVERT_BOOL</tt>)</span></dt>
<dd><p>       This means the host variable is of type <tt class="type">bool</tt> and
       the datum in the database is neither <tt class="literal">'t'</tt> nor
       <tt class="literal">'f'</tt>.  (SQLSTATE 42804)
      </p></dd>
<dt><span class="term">-208 (<tt class="symbol">ECPG_EMPTY</tt>)</span></dt>
<dd><p>       The statement sent to the <span class="productname">PostgreSQL</span>
       server was empty.  (This cannot normally happen in an embedded
       SQL program, so it may point to an internal error.)  (SQLSTATE
       YE002)
      </p></dd>
<dt><span class="term">-209 (<tt class="symbol">ECPG_MISSING_INDICATOR</tt>)</span></dt>
<dd><p>       A null value was returned and no null indicator variable was
       supplied.  (SQLSTATE 22002)
      </p></dd>
<dt><span class="term">-210 (<tt class="symbol">ECPG_NO_ARRAY</tt>)</span></dt>
<dd><p>       An ordinary variable was used in a place that requires an
       array.  (SQLSTATE 42804)
      </p></dd>
<dt><span class="term">-211 (<tt class="symbol">ECPG_DATA_NOT_ARRAY</tt>)</span></dt>
<dd><p>       The database returned an ordinary variable in a place that
       requires array value.  (SQLSTATE 42804)
      </p></dd>
<dt><span class="term">-220 (<tt class="symbol">ECPG_NO_CONN</tt>)</span></dt>
<dd><p>       The program tried to access a connection that does not exist.
       (SQLSTATE 08003)
      </p></dd>
<dt><span class="term">-221 (<tt class="symbol">ECPG_NOT_CONN</tt>)</span></dt>
<dd><p>       The program tried to access a connection that does exist but is
       not open.  (This is an internal error.)  (SQLSTATE YE002)
      </p></dd>
<dt><span class="term">-230 (<tt class="symbol">ECPG_INVALID_STMT</tt>)</span></dt>
<dd><p>       The statement you are trying to use has not been prepared.
       (SQLSTATE 26000)
      </p></dd>
<dt><span class="term">-240 (<tt class="symbol">ECPG_UNKNOWN_DESCRIPTOR</tt>)</span></dt>
<dd><p>       The descriptor specified was not found.  The statement you are
       trying to use has not been prepared.  (SQLSTATE 33000)
      </p></dd>
<dt><span class="term">-241 (<tt class="symbol">ECPG_INVALID_DESCRIPTOR_INDEX</tt>)</span></dt>
<dd><p>       The descriptor index specified was out of range.  (SQLSTATE
       07009)
      </p></dd>
<dt><span class="term">-242 (<tt class="symbol">ECPG_UNKNOWN_DESCRIPTOR_ITEM</tt>)</span></dt>
<dd><p>       An invalid descriptor item was requested.  (This is an internal
       error.)  (SQLSTATE YE002)
      </p></dd>
<dt><span class="term">-243 (<tt class="symbol">ECPG_VAR_NOT_NUMERIC</tt>)</span></dt>
<dd><p>       During the execution of a dynamic statement, the database
       returned a numeric value and the host variable was not numeric.
       (SQLSTATE 07006)
      </p></dd>
<dt><span class="term">-244 (<tt class="symbol">ECPG_VAR_NOT_CHAR</tt>)</span></dt>
<dd><p>       During the execution of a dynamic statement, the database
       returned a non-numeric value and the host variable was numeric.
       (SQLSTATE 07006)
      </p></dd>
<dt><span class="term">-400 (<tt class="symbol">ECPG_PGSQL</tt>)</span></dt>
<dd><p>       Some error caused by the <span class="productname">PostgreSQL</span>
       server.  The message contains the error message from the
       <span class="productname">PostgreSQL</span> server.
      </p></dd>
<dt><span class="term">-401 (<tt class="symbol">ECPG_TRANS</tt>)</span></dt>
<dd><p>       The <span class="productname">PostgreSQL</span> server signaled that
       we cannot start, commit, or rollback the transaction.
       (SQLSTATE 08007)
      </p></dd>
<dt><span class="term">-402 (<tt class="symbol">ECPG_CONNECT</tt>)</span></dt>
<dd><p>       The connection attempt to the database did not succeed.
       (SQLSTATE 08001)
      </p></dd>
<dt><span class="term">100 (<tt class="symbol">ECPG_NOT_FOUND</tt>)</span></dt>
<dd><p>       This is a harmless condition indicating that the last command
       retrieved or processed zero rows, or that you are at the end of
       the cursor.  (SQLSTATE 02000)
      </p></dd>
</dl></div>
<p>
  </p>
</div>
</div></body>
</html>
