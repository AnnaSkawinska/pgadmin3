<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>37.6. PL/Perl Triggers</title>
<link rel="stylesheet" href="stylesheet.css" type="text/css">
<link rev="made" href="pgsql-docs@postgresql.org">
<meta name="generator" content="DocBook XSL Stylesheets V1.64.1">
<link rel="home" href="index.html" title="PostgreSQL 8.0.2 Documentation">
<link rel="up" href="plperl.html" title="Chapter 37. PL/Perl - Perl Procedural Language">
<link rel="previous" href="plperl-trusted.html" title="37.5. Trusted and Untrusted PL/Perl">
<link rel="next" href="plperl-missing.html" title="37.7. Limitations and Missing Features">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="sect1" lang="en">
<div class="titlepage">
<div><div><h2 class="title" style="clear: both">
<a name="plperl-triggers"></a>37.6. PL/Perl Triggers</h2></div></div>
<div></div>
</div>
<p>   PL/Perl can be used to write trigger functions.  In a trigger function,
   the hash reference <tt class="varname">$_TD</tt> contains information about the
   current trigger event.  The fields of the <tt class="varname">$_TD</tt> hash
   reference are:

   </p>
<div class="variablelist"><dl>
<dt><span class="term"><tt class="literal">$_TD-&gt;{new}{foo}</tt></span></dt>
<dd><p>       <tt class="literal">NEW</tt> value of column <tt class="literal">foo</tt>
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{old}{foo}</tt></span></dt>
<dd><p>       <tt class="literal">OLD</tt> value of column <tt class="literal">foo</tt>
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{name}</tt></span></dt>
<dd><p>       Name of the trigger being called
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{event}</tt></span></dt>
<dd><p>       Trigger event: <tt class="literal">INSERT</tt>, <tt class="literal">UPDATE</tt>, <tt class="literal">DELETE</tt>, or <tt class="literal">UNKNOWN</tt>
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{when}</tt></span></dt>
<dd><p>       When the trigger was called: <tt class="literal">BEFORE</tt>, <tt class="literal">AFTER</tt>, or <tt class="literal">UNKNOWN</tt>
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{level}</tt></span></dt>
<dd><p>       The trigger level: <tt class="literal">ROW</tt>, <tt class="literal">STATEMENT</tt>, or <tt class="literal">UNKNOWN</tt>
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{relid}</tt></span></dt>
<dd><p>       OID of the table on which the trigger fired
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{relname}</tt></span></dt>
<dd><p>       Name of the table on which the trigger fired
      </p></dd>
<dt><span class="term"><tt class="literal">$_TD-&gt;{argc}</tt></span></dt>
<dd><p>       Number of arguments of the trigger function
      </p></dd>
<dt><span class="term"><tt class="literal">@{$_TD-&gt;{args}}</tt></span></dt>
<dd><p>       Arguments of the trigger function.  Does not exist if $_TD-&gt;{argc} is 0.
      </p></dd>
</dl></div>
<p>
  </p>
<p>   Triggers can return one of the following:

   </p>
<div class="variablelist"><dl>
<dt><span class="term"><tt class="literal">return;</tt></span></dt>
<dd><p>       Execute the statement
      </p></dd>
<dt><span class="term"><tt class="literal">"SKIP"</tt></span></dt>
<dd><p>       Don't execute the statement
      </p></dd>
<dt><span class="term"><tt class="literal">"MODIFY"</tt></span></dt>
<dd><p>       Indicates that the <tt class="literal">NEW</tt> row was modified by
       the trigger function
      </p></dd>
</dl></div>
<p>
  </p>
<p>   Here is an example of a trigger function, illustrating some of the
   above:
</p>
<pre class="programlisting">CREATE TABLE test (
    i int,
    v varchar
);

CREATE OR REPLACE FUNCTION valid_id() RETURNS trigger AS $$
    if (($_TD-&gt;{new}{i} &gt;= 100) || ($_TD-&gt;{new}{i} &lt;= 0)) {
        return "SKIP";    # skip INSERT/UPDATE command
    } elsif ($_TD-&gt;{new}{v} ne "immortal") {
        $_TD-&gt;{new}{v} .= "(modified by trigger)";
        return "MODIFY";  # modify row and execute INSERT/UPDATE command
    } else {
        return;           # execute INSERT/UPDATE command
    }
$$ LANGUAGE plperl;

CREATE TRIGGER test_valid_id_trig
    BEFORE INSERT OR UPDATE ON test
    FOR EACH ROW EXECUTE PROCEDURE valid_id();</pre>
<p>
  </p>
</div></body>
</html>
